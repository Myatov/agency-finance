generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Department {
  id        String   @id @default(uuid())
  name      String   @unique
  headId    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  head      User?    @relation("DepartmentHead", fields: [headId], references: [id])
  employees User[]   @relation("DepartmentEmployees")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  code        String           @unique
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       User[]

  @@index([code])
}

model RolePermission {
  id         String   @id @default(uuid())
  roleId     String
  section    String
  permission String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, section, permission])
  @@index([roleId])
  @@index([section])
}

model User {
  id                  String      @id @default(uuid())
  fullName            String
  departmentId        String?
  roleId              String
  passwordHash        String
  isActive            Boolean     @default(true)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  clientSales         Client[]    @relation("ClientSeller")
  managedDepartment   Department? @relation("DepartmentHead")
  createdExpenses     Expense[]   @relation("ExpenseCreator")
  expenseEmployee     Expense[]   @relation("ExpenseEmployee")
  updatedExpenses     Expense[]   @relation("ExpenseUpdater")
  createdIncomes      Income[]    @relation("IncomeCreator")
  updatedIncomes      Income[]    @relation("IncomeUpdater")
  responsibleServices Service[]   @relation("ServiceResponsible")
  managedSites        Site[]      @relation("SiteAccountManager")
  createdSites        Site[]      @relation("SiteCreator")
  department          Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  role                Role        @relation(fields: [roleId], references: [id])

  @@index([departmentId])
  @@index([roleId])
}

model LegalEntity {
  id              String          @id @default(uuid())
  name            String          @unique
  type            LegalEntityType
  usnPercent      Float           @default(0)
  vatPercent      Float           @default(0)
  isActive        Boolean         @default(true)
  generalDirector String?
  activityBasis   String?
  legalAddress    String?
  inn             String?
  kpp             String?
  ogrn            String?
  rs              String?
  bankName        String?
  bik             String?
  ks              String?
  paymentInfo     String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  clients         Client[]
  incomes         Income[]

  @@index([isActive])
  @@map("LegalEntity")
}

model Client {
  id                String       @id @default(uuid())
  name              String
  legalEntityId     String?
  sellerEmployeeId  String
  legalEntityName   String?
  contractBasis     String?
  legalAddress      String?
  inn               String?
  kpp               String?
  ogrn              String?
  rs                String?
  bankName          String?
  bik               String?
  ks                String?
  paymentRequisites String?
  contacts          String?
  isSystem          Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  legalEntity       LegalEntity? @relation(fields: [legalEntityId], references: [id])
  seller            User         @relation("ClientSeller", fields: [sellerEmployeeId], references: [id])
  sites             Site[]

  @@index([sellerEmployeeId])
  @@index([legalEntityId])
  @@index([sellerEmployeeId, isSystem])
}

model Product {
  id        String    @id @default(uuid())
  name      String    @unique
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  services  Service[]

  @@index([sortOrder])
}

model Site {
  id               String    @id @default(uuid())
  title            String
  websiteUrl       String?
  description      String?
  isActive         Boolean   @default(false)
  niche            String
  clientId         String
  accountManagerId String?
  creatorId        String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  expenses         Expense[]
  services         Service[]
  accountManager   User?     @relation("SiteAccountManager", fields: [accountManagerId], references: [id])
  client           Client    @relation(fields: [clientId], references: [id])
  creator          User      @relation("SiteCreator", fields: [creatorId], references: [id])

  @@index([clientId])
  @@index([accountManagerId])
  @@index([creatorId])
  @@index([isActive])
  @@index([clientId, isActive])
  @@map("Site")
}

model Service {
  id                String        @id @default(uuid())
  siteId            String
  productId         String
  status            ServiceStatus @default(ACTIVE)
  startDate         DateTime
  endDate           DateTime?
  billingType       BillingType
  price             BigInt?
  autoRenew         Boolean       @default(false)
  responsibleUserId String?
  comment           String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  expenses          Expense[]
  incomes           Income[]
  product           Product       @relation(fields: [productId], references: [id])
  responsible       User?         @relation("ServiceResponsible", fields: [responsibleUserId], references: [id])
  site              Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([productId])
  @@index([status])
  @@index([responsibleUserId])
  @@index([siteId, status])
  @@map("Service")
}

model Income {
  id              String       @id @default(uuid())
  amount          BigInt
  serviceId       String
  legalEntityId   String?
  comment         String?
  incomeDate      DateTime     @default(now())
  createdByUserId String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime?
  updatedByUserId String?
  creator         User         @relation("IncomeCreator", fields: [createdByUserId], references: [id])
  legalEntity     LegalEntity? @relation(fields: [legalEntityId], references: [id])
  service         Service      @relation(fields: [serviceId], references: [id])
  updater         User?        @relation("IncomeUpdater", fields: [updatedByUserId], references: [id])

  @@index([serviceId])
  @@index([createdByUserId])
  @@index([incomeDate])
  @@index([legalEntityId])
  @@index([createdAt])
  @@index([createdByUserId, createdAt])
}

model CostItem {
  id        String       @id @default(uuid())
  category  CostCategory
  title     String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  expenses  Expense[]

  @@index([category])
}

model Expense {
  id              String    @id @default(uuid())
  amount          BigInt
  costItemId      String
  title           String?
  employeeId      String?
  siteId          String?
  serviceId       String?
  comment         String?
  createdByUserId String
  createdAt       DateTime  @default(now())
  paymentAt       DateTime  @default(now())
  updatedAt       DateTime?
  updatedByUserId String?
  costItem        CostItem  @relation(fields: [costItemId], references: [id])
  creator         User      @relation("ExpenseCreator", fields: [createdByUserId], references: [id])
  employee        User?     @relation("ExpenseEmployee", fields: [employeeId], references: [id])
  service         Service?  @relation(fields: [serviceId], references: [id])
  site            Site?     @relation(fields: [siteId], references: [id])
  updater         User?     @relation("ExpenseUpdater", fields: [updatedByUserId], references: [id])

  @@index([costItemId])
  @@index([employeeId])
  @@index([siteId])
  @@index([serviceId])
  @@index([createdByUserId])
  @@index([paymentAt])
  @@index([createdAt])
  @@index([createdByUserId, paymentAt])
}

enum LegalEntityType {
  IP
  OOO
  CARD
  CRYPTO
  BARTER
}

enum CostCategory {
  SALARY
  SALES_PERCENT
  OFFICE
  HR
  AGENCY_PAYMENTS
  SERVICES
  LINKS
  CONTRACTOR
  OTHER
}

enum ServiceStatus {
  ACTIVE
  PAUSED
  FINISHED
}

enum BillingType {
  ONE_TIME
  MONTHLY
  QUARTERLY
  YEARLY
}

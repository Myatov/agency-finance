generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Department {
  id        String   @id @default(uuid())
  name      String   @unique
  headId    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  head      User?    @relation("DepartmentHead", fields: [headId], references: [id])
  employees User[]   @relation("DepartmentEmployees")
  paymentSchedule DepartmentPaymentSchedule?
  expenseItemTemplates ExpenseItemTemplate[]
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  code        String           @unique
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       User[]

  @@index([code])
}

model RolePermission {
  id         String   @id @default(uuid())
  roleId     String
  section    String
  permission String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, section, permission])
  @@index([roleId])
  @@index([section])
}

model User {
  id                  String      @id @default(uuid())
  fullName            String
  departmentId        String?
  roleId              String
  passwordHash        String
  isActive            Boolean     @default(true)
  birthDate           DateTime?
  workStartDate       DateTime?
  emailWork           String?
  emailGoogle         String?
  phonePersonal       String?
  phoneWork           String?
  telegramPersonal    String?
  telegramWork        String?
  hasSpouse           Boolean?
  hasChildren         Boolean?
  childrenCount       Int?
  childrenBirthDates   String?
  fixedSalary         BigInt?     // Текущий фикс (копейки)
  officialSalary      BigInt?     // Офиц ЗП (копейки)
  salaryTaxPercent    Float?      // Налог на ЗП (%)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  clientSales         Client[]    @relation("ClientSeller")
  managedClients      Client[]    @relation("ClientAccountManager")
  managedDepartment   Department? @relation("DepartmentHead")
  createdExpenses     Expense[]   @relation("ExpenseCreator")
  expenseEmployee     Expense[]   @relation("ExpenseEmployee")
  updatedExpenses     Expense[]   @relation("ExpenseUpdater")
  createdIncomes      Income[]    @relation("IncomeCreator")
  updatedIncomes      Income[]    @relation("IncomeUpdater")
  responsibleServices Service[]   @relation("ServiceResponsible")
  managedSites        Site[]      @relation("SiteAccountManager") // DEPRECATED: будет удалён после миграции
  createdSites        Site[]      @relation("SiteCreator")
  department          Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  role                Role        @relation(fields: [roleId], references: [id])
  uploadedContracts   ContractDocument[]   @relation("ContractUploader")
  uploadedCloseoutDocs CloseoutDocument[]   @relation("CloseoutDocUploader")
  periodReports       WorkPeriodReport[]   @relation("PeriodReportAM")
  createdInvoices         Invoice[]            @relation("InvoiceCreator")
  createdPayments         Payment[]            @relation("PaymentCreator")
  createdClientPortals    ClientPortalAccess[]  @relation("ClientPortalCreator")
  createdPeriodInvoiceNotes PeriodInvoiceNote[] @relation("PeriodInvoiceNoteCreator")
  fixedSalaryHistory  UserFixedSalaryHistory[]
  motivations         UserMotivation[]
  responsibleExpenseItems ServiceExpenseItem[] @relation("ExpenseItemResponsible")
  auditLogs              AuditLog[]           @relation("AuditLogUser")

  @@index([departmentId])
  @@index([roleId])
}

model LegalEntity {
  id                    String          @id @default(uuid())
  name                  String          @unique
  type                  LegalEntityType
  usnPercent            Float           @default(0)
  vatPercent            Float           @default(0)
  isActive              Boolean         @default(true)
  fullName              String?         // Полное название юридического лица
  contactInfo           String?         // Контактные данные
  generalDirector       String?
  activityBasis         String?
  legalAddress         String?
  inn                   String?
  kpp                   String?
  ogrn                  String?
  rs                    String?
  bankName              String?
  bik                   String?
  ks                    String?
  paymentInfo           String?
  generateClosingDocs   Boolean         @default(false)
  closingDocPerInvoice  Boolean?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  clients               Client[]
  incomes               Income[]
  expenses              Expense[]
  invoices              Invoice[]
  periodInvoiceNotes    PeriodInvoiceNote[]

  @@index([isActive])
  @@map("LegalEntity")
}

enum AgentSource {
  PARTNER
  AGENT
  REFERRER
  EMPLOYEE
}

enum AgentStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum CommissionRoleType {
  SELLER
  ACCOUNT_MANAGER
}

enum ExpenseItemValueType {
  PERCENT
  FIXED
}

model Agent {
  id                      String       @id @default(uuid())
  name                    String
  companyName             String?
  professionalActivity    String?
  phone                   String?
  telegram                String?
  position                String?
  commissionOnTop         Boolean      @default(false)
  commissionInOurAmount   Boolean      @default(false)
  desiredCommissionPercent Float?
  sellsOnBehalfOfCompany  Boolean      @default(false)
  transfersForClosingToUs Boolean      @default(false)
  description             String?
  source                  AgentSource?
  status                  AgentStatus  @default(ACTIVE)
  portalToken             String?      @unique
  portalPassword          String?
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  clients                 Client[]

  @@index([name])
  @@index([phone])
  @@index([telegram])
  @@index([status])
}

model Client {
  id                String          @id @default(uuid())
  name              String
  legalEntityId     String?
  sellerEmployeeId  String
  accountManagerId  String?         // Аккаунт-менеджер назначается на уровне клиента (1 клиент = 1 АМ)
  agentId           String?
  legalEntityName   String?
  legalAddress     String?
  inn               String?
  kpp               String?
  ogrn              String?
  rs                String?
  bankName          String?
  bik               String?
  ks                String?
  paymentRequisites String?
  contacts          String?
  isReturningClient Boolean         @default(false)
  isKeyClient       Boolean         @default(false)
  keyClientStatusComment    String?
  returningClientStatusComment String?
  isSystem          Boolean         @default(false)
  isArchived        Boolean         @default(false)
  workStartDate     DateTime?       // Дата старта работы с клиентом (ни на что не влияет, для справки)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  legalEntity       LegalEntity?    @relation(fields: [legalEntityId], references: [id])
  seller            User            @relation("ClientSeller", fields: [sellerEmployeeId], references: [id])
  accountManager    User?           @relation("ClientAccountManager", fields: [accountManagerId], references: [id])
  agent             Agent?          @relation(fields: [agentId], references: [id], onDelete: SetNull)
  sites             Site[]
  contractDocuments ContractDocument[]
  closeoutPackages  CloseoutPackage[]
  closeoutDocuments CloseoutDocument[]
  clientContacts    ClientContact[]
  portalAccess      ClientPortalAccess?

  @@index([sellerEmployeeId])
  @@index([legalEntityId])
  @@index([accountManagerId])
  @@index([agentId])
  @@index([sellerEmployeeId, isSystem])
}

model ClientPortalAccess {
  id              String   @id @default(uuid())
  clientId        String   @unique
  passwordHash    String
  accessToken     String   @unique
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy       User     @relation("ClientPortalCreator", fields: [createdByUserId], references: [id])

  @@index([accessToken])
  @@index([clientId])
}

enum ContactRoleAtClient {
  OWNER
  MARKETING
  FINANCE
  IT
  OTHER
}

model Contact {
  id          String          @id @default(uuid())
  name        String
  phone1      String?
  phone2      String?
  birthDate   DateTime?
  telegram    String?
  whatsapp    String?
  position    String?
  note        String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  clientLinks ClientContact[]

  @@index([name])
  @@index([phone1])
  @@index([telegram])
  @@index([whatsapp])
}

model ClientContact {
  id         String            @id @default(uuid())
  clientId   String
  contactId  String
  role       ContactRoleAtClient? @default(OTHER)
  isPrimary  Boolean           @default(false)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  client     Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contact    Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([clientId, contactId])
  @@index([clientId])
  @@index([contactId])
}

model Product {
  id        String    @id @default(uuid())
  name      String    @unique
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  services  Service[]
  expenseItems       ProductExpenseItem[]
  commissions        ProductCommission[]
  accountManagerFees ProductAccountManagerFee[]

  @@index([sortOrder])
}

model Site {
  id               String    @id @default(uuid())
  title            String
  websiteUrl       String?
  description      String?
  isActive         Boolean   @default(false)
  niche            String
  clientId         String
  accountManagerId String?   // DEPRECATED: будет удалён после миграции на Client.accountManagerId
  creatorId        String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  expenses         Expense[]
  services         Service[]
  accountManager   User?     @relation("SiteAccountManager", fields: [accountManagerId], references: [id])
  client           Client    @relation(fields: [clientId], references: [id])
  creator          User      @relation("SiteCreator", fields: [creatorId], references: [id])
  contractDocuments ContractDocument[]
  contractSections  ContractSection[]
  closeoutPackages  CloseoutPackage[]

  @@index([clientId])
  @@index([accountManagerId])
  @@index([creatorId])
  @@index([isActive])
  @@index([clientId, isActive])
  @@map("Site")
}

enum PrepaymentType {
  FULL_PREPAY
  PARTIAL_PREPAY
  POSTPAY
}

model Service {
  id                String          @id @default(uuid())
  siteId            String
  productId         String
  status            ServiceStatus   @default(ACTIVE)
  startDate         DateTime
  endDate           DateTime?
  billingType       BillingType
  prepaymentType    PrepaymentType  @default(POSTPAY)
  price             BigInt?
  autoRenew         Boolean         @default(false)
  responsibleUserId String?
  comment           String?
  isFromPartner     Boolean         @default(false) // Лид от партнёра/агента — влияет на комиссии
  sellerCommissionPercent     Float?   // Рассчитанный % комиссии продавца
  sellerCommissionAmount      BigInt?  // Рассчитанная сумма комиссии продавца (копейки)
  accountManagerCommissionPercent Float? // Рассчитанный % комиссии АМ
  accountManagerCommissionAmount  BigInt? // Рассчитанная сумма комиссии АМ (копейки)
  accountManagerFeeAmount     BigInt?  // Сумма ведения проекта АМ (копейки)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  expenses          Expense[]
  incomes           Income[]
  product           Product       @relation(fields: [productId], references: [id])
  responsible       User?         @relation("ServiceResponsible", fields: [responsibleUserId], references: [id])
  site              Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  closeoutPackages  CloseoutPackage[]
  workPeriods      WorkPeriod[]
  expenseItems     ServiceExpenseItem[]
  auditLogs        AuditLog[]           @relation("AuditLogService")

  @@index([siteId])
  @@index([productId])
  @@index([status])
  @@index([responsibleUserId])
  @@index([siteId, status])
  @@map("Service")
}

enum WorkPeriodType {
  STANDARD
  EXTENDED
  BONUS
  COMPENSATION
}

enum PeriodReportPaymentType {
  PREPAY
  POSTPAY
  FRACTIONAL
}

model WorkPeriod {
  id                  String           @id @default(uuid())
  serviceId           String
  dateFrom            DateTime
  dateTo              DateTime
  periodType          WorkPeriodType   @default(STANDARD)
  invoiceNotRequired  Boolean          @default(false)
  expectedAmount      BigInt?          // Ожидаемая сумма за этот период (копейки). Если null — берётся из услуги (price). Позволяет иметь разную цену по периодам.
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  service             Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  invoices            Invoice[]
  invoiceLines        InvoiceLine[]    // Строки счетов по этому периоду (1 счёт = несколько услуг)
  incomes             Income[]
  periodReport        WorkPeriodReport?
  closeoutDocuments   CloseoutDocument[]
  periodInvoiceNotes  PeriodInvoiceNote[] // Пометки «Счёт выставлен на X» без формирования счёта (ЮЛ без галочки)

  @@unique([serviceId, dateFrom, dateTo])
  @@index([serviceId])
  @@index([dateFrom, dateTo])
  @@map("WorkPeriod")
}

model WorkPeriodReport {
  id               String                   @id @default(uuid())
  workPeriodId     String                   @unique
  filePath         String
  originalName     String
  mimeType         String?
  sizeBytes        Int?
  paymentType      PeriodReportPaymentType
  accountManagerId String
  completedAt      DateTime                 @default(now())
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  workPeriod       WorkPeriod               @relation(fields: [workPeriodId], references: [id], onDelete: Cascade)
  accountManager   User                     @relation("PeriodReportAM", fields: [accountManagerId], references: [id])

  @@index([workPeriodId])
  @@index([accountManagerId])
  @@map("WorkPeriodReport")
}

model PeriodInvoiceNote {
  id              String       @id @default(uuid())
  workPeriodId    String
  amount          BigInt
  legalEntityId   String
  invoiceNumber   String?
  issuedAt        DateTime?
  createdAt       DateTime     @default(now())
  createdByUserId String?
  workPeriod      WorkPeriod   @relation(fields: [workPeriodId], references: [id], onDelete: Cascade)
  legalEntity     LegalEntity  @relation(fields: [legalEntityId], references: [id])
  creator         User?        @relation("PeriodInvoiceNoteCreator", fields: [createdByUserId], references: [id])

  @@index([workPeriodId])
  @@index([legalEntityId])
  @@map("PeriodInvoiceNote")
}

model Invoice {
  id                          String    @id @default(uuid())
  workPeriodId                String    // «Главный» период (для обратной совместимости; при нескольких строках — первый период)
  amount                      BigInt
  coverageFrom                DateTime?
  coverageTo                  DateTime?
  invoiceNumber               String?
  invoiceDate                 DateTime? // Дата счёта (для отображения и PDF)
  legalEntityId               String
  generateClosingDocsAtInvoice Boolean  @default(false)
  closingDocPerInvoiceAtInvoice Boolean?
  invoiceNotRequired          Boolean   @default(false)
  publicToken                 String?   @unique
  pdfGeneratedAt              DateTime? // Когда сформирован и сохранён PDF файл счёта
  createdAt                   DateTime  @default(now())
  createdByUserId             String?
  updatedAt                   DateTime  @updatedAt
  workPeriod                  WorkPeriod @relation(fields: [workPeriodId], references: [id], onDelete: Cascade)
  legalEntity                 LegalEntity @relation(fields: [legalEntityId], references: [id])
  creator                     User?     @relation("InvoiceCreator", fields: [createdByUserId], references: [id])
  payments                    Payment[]
  closeoutDocuments           CloseoutDocument[]
  lines                       InvoiceLine[]

  @@index([workPeriodId])
  @@index([legalEntityId])
  @@index([createdByUserId])
  @@index([publicToken])
  @@map("Invoice")
}

model InvoiceLine {
  id                 String    @id @default(uuid())
  invoiceId          String
  workPeriodId       String
  amount             BigInt
  sortOrder          Int       @default(0)
  serviceNameOverride String?  // Название услуги в счёте (если не из периода)
  siteNameOverride   String?   // Название/адрес сайта в счёте
  periodOverride     String?   // Период в счёте (например «01.01.2025 — 31.01.2025»), иначе из workPeriod
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  invoice            Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  workPeriod         WorkPeriod @relation(fields: [workPeriodId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([workPeriodId])
  @@map("InvoiceLine")
}

model Payment {
  id              String   @id @default(uuid())
  invoiceId       String
  amount          BigInt
  paidAt          DateTime @default(now())
  comment         String?
  createdByUserId String
  createdAt       DateTime @default(now())
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  creator         User     @relation("PaymentCreator", fields: [createdByUserId], references: [id])

  @@index([invoiceId])
  @@index([createdByUserId])
  @@index([paidAt])
  @@map("Payment")
}

model Income {
  id              String       @id @default(uuid())
  amount          BigInt
  serviceId       String
  workPeriodId    String?
  legalEntityId   String?
  comment         String?
  incomeDate      DateTime     @default(now())
  createdByUserId String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime?
  updatedByUserId String?
  creator         User         @relation("IncomeCreator", fields: [createdByUserId], references: [id])
  legalEntity     LegalEntity? @relation(fields: [legalEntityId], references: [id])
  service         Service      @relation(fields: [serviceId], references: [id])
  workPeriod      WorkPeriod?  @relation(fields: [workPeriodId], references: [id], onDelete: SetNull)
  updater         User?        @relation("IncomeUpdater", fields: [updatedByUserId], references: [id])
  expensesFromIncome Expense[] @relation("ExpenseFromIncome")

  @@index([serviceId])
  @@index([workPeriodId])
  @@index([createdByUserId])
  @@index([incomeDate])
  @@index([legalEntityId])
  @@index([createdAt])
  @@index([createdByUserId, createdAt])
}

model CostCategory {
  id        String     @id @default(uuid())
  name      String     @unique
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  costItems CostItem[]

  @@index([sortOrder])
}

model FinancialModelExpenseType {
  id        String     @id @default(uuid())
  name      String     @unique
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  costItems CostItem[]

  @@index([sortOrder])
}

model Niche {
  id        String   @id @default(uuid())
  name      String   @unique
  parentId  String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  parent    Niche?   @relation("NicheHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Niche[]  @relation("NicheHierarchy")

  @@index([sortOrder])
  @@index([parentId])
}

model CostItem {
  id                         String                     @id @default(uuid())
  costCategoryId             String
  title                      String
  sortOrder                  Int                        @default(0)
  financialModelExpenseTypeId String
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  costCategory               CostCategory               @relation(fields: [costCategoryId], references: [id], onDelete: Restrict)
  financialModelExpenseType  FinancialModelExpenseType  @relation(fields: [financialModelExpenseTypeId], references: [id], onDelete: Restrict)
  expenses                   Expense[]

  @@index([costCategoryId])
  @@index([financialModelExpenseTypeId])
  @@index([sortOrder])
}

model Expense {
  id               String       @id @default(uuid())
  amount           BigInt
  costItemId       String
  title            String?
  employeeId       String?
  siteId           String?
  serviceId        String?
  legalEntityId    String?
  comment          String?
  isWithdrawal     Boolean      @default(false) // Галочка «снятие» — снятие средств с юрлица
  createdByUserId  String
  createdAt        DateTime     @default(now())
  paymentAt        DateTime     @default(now())
  updatedAt        DateTime?
  updatedByUserId  String?
  sourceIncomeId   String?      @unique
  costItem         CostItem     @relation(fields: [costItemId], references: [id])
  creator          User         @relation("ExpenseCreator", fields: [createdByUserId], references: [id])
  employee         User?        @relation("ExpenseEmployee", fields: [employeeId], references: [id])
  service          Service?     @relation(fields: [serviceId], references: [id])
  site             Site?        @relation(fields: [siteId], references: [id])
  legalEntity      LegalEntity? @relation(fields: [legalEntityId], references: [id])
  updater          User?        @relation("ExpenseUpdater", fields: [updatedByUserId], references: [id])
  sourceIncome     Income?      @relation("ExpenseFromIncome", fields: [sourceIncomeId], references: [id], onDelete: SetNull)

  @@index([costItemId])
  @@index([employeeId])
  @@index([siteId])
  @@index([serviceId])
  @@index([legalEntityId])
  @@index([createdByUserId])
  @@index([paymentAt])
  @@index([createdAt])
  @@index([sourceIncomeId])
  @@index([createdByUserId, paymentAt])
}

// ——— Хранилище: Договора ———
enum ContractDocType {
  CONTRACT
  ADDENDUM
  NDA
  OTHER
}

enum ContractStatus {
  ACTIVE
  CLOSED
}

model ContractDocument {
  id              String          @id @default(uuid())
  clientId        String
  siteId          String?
  type            ContractDocType @default(CONTRACT)
  parentId        String?
  filePath        String
  originalName    String
  mimeType        String?
  sizeBytes       Int?
  docNumber       String?
  docDate         DateTime?
  endDate         DateTime?
  comment         String?
  tags            String?
  status          ContractStatus  @default(ACTIVE)
  uploadedById    String
  uploadedAt      DateTime        @default(now())
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  site            Site?           @relation(fields: [siteId], references: [id], onDelete: SetNull)
  uploader        User            @relation("ContractUploader", fields: [uploadedById], references: [id])
  sections        ContractSection[]
  children        ContractDocument[] @relation("ContractChildren")
  parent          ContractDocument?  @relation("ContractChildren", fields: [parentId], references: [id])

  @@index([clientId])
  @@index([siteId])
  @@index([uploadedById])
  @@index([status])
  @@index([uploadedAt])
}

model ContractSection {
  id          String           @id @default(uuid())
  contractId  String
  title       String
  comment     String?
  siteId      String?
  serviceId   String?
  contract    ContractDocument @relation(fields: [contractId], references: [id], onDelete: Cascade)
  site        Site?            @relation(fields: [siteId], references: [id], onDelete: SetNull)

  @@index([contractId])
}

enum CloseoutPeriodType {
  MONTH
  STAGE
  ONE_TIME
}

enum CloseoutPackageStatus {
  PREPARING
  SENT
  SIGNED
}

enum CloseoutDocType {
  ACT
  INVOICE
  SF
  UPD
  RECONCILIATION
  REPORT
  OTHER
}

enum CloseoutDocStatus {
  DRAFT
  SIGNED
}

model CloseoutPackage {
  id          String                @id @default(uuid())
  clientId    String
  siteId      String?
  serviceId   String?
  period      String
  periodType  CloseoutPeriodType    @default(MONTH)
  amount      BigInt?
  status      CloseoutPackageStatus @default(PREPARING)
  client      Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  site        Site?                 @relation(fields: [siteId], references: [id], onDelete: SetNull)
  service     Service?              @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  documents   CloseoutDocument[]

  @@index([clientId])
  @@index([period])
  @@index([status])
}

model CloseoutDocument {
  id            String            @id @default(uuid())
  packageId     String?
  clientId      String
  period        String?
  workPeriodId  String?
  invoiceId     String?
  docType       CloseoutDocType    @default(ACT)
  filePath      String
  originalName  String
  mimeType      String?
  sizeBytes     Int?
  docDate       DateTime?
  amount        BigInt?
  status        CloseoutDocStatus   @default(DRAFT)
  comment       String?
  uploadedById  String
  uploadedAt    DateTime          @default(now())
  package       CloseoutPackage?   @relation(fields: [packageId], references: [id], onDelete: SetNull)
  client        Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  uploader      User              @relation("CloseoutDocUploader", fields: [uploadedById], references: [id])
  workPeriod    WorkPeriod?       @relation(fields: [workPeriodId], references: [id], onDelete: SetNull)
  invoice       Invoice?          @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([packageId])
  @@index([period])
  @@index([uploadedById])
  @@index([workPeriodId])
  @@index([invoiceId])
}

enum LegalEntityType {
  IP
  OOO
  CARD
  CRYPTO
  BARTER
}

enum ServiceStatus {
  ACTIVE
  PAUSED
  FINISHED
}

enum BillingType {
  ONE_TIME
  MONTHLY
  QUARTERLY
  YEARLY
}

// ——— Справочник «Статьи ожидаемых расходов» ———
model ExpenseItemTemplate {
  id           String      @id @default(uuid())
  name         String      @unique
  departmentId String?     // Связь с отделом — для автоматического назначения ответственных
  sortOrder    Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  department   Department? @relation(fields: [departmentId], references: [id])
  productItems ProductExpenseItem[]
  serviceItems ServiceExpenseItem[]

  @@index([sortOrder])
  @@index([departmentId])
}

// ——— Статьи расходов для каждого Продукта (шаблоны) ———
model ProductExpenseItem {
  id                    String              @id @default(uuid())
  productId             String
  expenseItemTemplateId String
  valueType             ExpenseItemValueType @default(PERCENT)
  defaultValue          Float               @default(0) // e.g. 6 для 6% или 5000 для фикса
  description           String?
  sortOrder             Int                 @default(0)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  product               Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  template              ExpenseItemTemplate @relation(fields: [expenseItemTemplateId], references: [id])

  @@unique([productId, expenseItemTemplateId])
  @@index([productId])
}

// ——— Настройки комиссий продавца и АМ для каждого Продукта ———
model ProductCommission {
  id              String             @id @default(uuid())
  productId       String
  role            CommissionRoleType
  standardPercent Float              @default(0) // Обычный случай, %
  partnerPercent  Float              @default(0) // Лид от агента/партнёра, %
  calculationBase String?            // JSON: описание формулы расчёта базы (от чего считать %)
  description     String?            // Человекочитаемое описание формулы
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  product         Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, role])
  @@index([productId])
}

// ——— Ставки ведения проекта АМ (условия по каждому Продукту) ———
model ProductAccountManagerFee {
  id             String   @id @default(uuid())
  productId      String
  conditionField String?  // Поле условия: "keyCount", "price", etc.
  conditionMin   Float?   // Минимальное значение условия
  conditionMax   Float?   // Максимальное значение условия (null = без ограничения)
  feeAmount      BigInt   // Сумма ведения (копейки)
  description    String?  // Описание условия
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// ——— Фактические статьи расходов для конкретной Услуги ———
model ServiceExpenseItem {
  id                    String              @id @default(uuid())
  serviceId             String
  expenseItemTemplateId String?
  responsibleUserId     String?             // Ответственный сотрудник за эту статью расходов
  name                  String              // Название (копируется из шаблона)
  valueType             ExpenseItemValueType @default(PERCENT)
  value                 Float               @default(0) // Фактическое значение
  calculatedAmount      BigInt?             // Расчётная сумма (копейки)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  service               Service             @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  template              ExpenseItemTemplate? @relation(fields: [expenseItemTemplateId], references: [id])
  responsible           User?               @relation("ExpenseItemResponsible", fields: [responsibleUserId], references: [id])

  @@index([serviceId])
  @@index([responsibleUserId])
}

// ——— История фикса сотрудника ———
model UserFixedSalaryHistory {
  id            String   @id @default(uuid())
  userId        String
  amount        BigInt   // Сумма фикса (копейки)
  effectiveFrom DateTime // С какой даты действует
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([effectiveFrom])
}

// ——— Мотивация сотрудника за период ———
model UserMotivation {
  id           String    @id @default(uuid())
  userId       String
  periodFrom   DateTime
  periodTo     DateTime
  targetAmount BigInt?   // Цель (оборот, копейки)
  bonusAmount  BigInt?   // Бонус при достижении цели (копейки)
  description  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([periodFrom, periodTo])
}

// ——— Лог изменений (история) ———
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  // Кто внёс изменение
  action      String   // CREATE, UPDATE, DELETE
  entityType  String   // SERVICE_EXPENSE, WORK_PERIOD, SERVICE, etc.
  entityId    String?  // ID изменённой сущности
  serviceId   String?  // ID услуги (проекта)
  description String   // Описание изменения
  oldValue    String?  // Старое значение (JSON)
  newValue    String?  // Новое значение (JSON)
  createdAt   DateTime @default(now())
  user        User?    @relation("AuditLogUser", fields: [userId], references: [id])
  service     Service? @relation("AuditLogService", fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([entityType])
  @@index([serviceId])
  @@index([userId])
  @@index([createdAt])
}

// ——— График выплат по отделам (зарплата раз в 2 недели) ———
model DepartmentPaymentSchedule {
  id           String     @id @default(uuid())
  departmentId String     @unique
  payDay1      Int        @default(1)  // Первый день выплаты в месяце
  payDay2      Int        @default(15) // Второй день выплаты в месяце
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
}

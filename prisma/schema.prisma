generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Department {
  id        String   @id @default(uuid())
  name      String   @unique
  headId    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  head      User?    @relation("DepartmentHead", fields: [headId], references: [id])
  employees User[]   @relation("DepartmentEmployees")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  code        String           @unique
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       User[]

  @@index([code])
}

model RolePermission {
  id         String   @id @default(uuid())
  roleId     String
  section    String
  permission String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, section, permission])
  @@index([roleId])
  @@index([section])
}

model User {
  id                  String      @id @default(uuid())
  fullName            String
  departmentId        String?
  roleId              String
  passwordHash        String
  isActive            Boolean     @default(true)
  birthDate           DateTime?
  workStartDate       DateTime?
  emailWork           String?
  emailGoogle         String?
  phonePersonal       String?
  phoneWork           String?
  telegramPersonal    String?
  telegramWork        String?
  hasSpouse           Boolean?
  hasChildren         Boolean?
  childrenCount       Int?
  childrenBirthDates   String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  clientSales         Client[]    @relation("ClientSeller")
  managedDepartment   Department? @relation("DepartmentHead")
  createdExpenses     Expense[]   @relation("ExpenseCreator")
  expenseEmployee     Expense[]   @relation("ExpenseEmployee")
  updatedExpenses     Expense[]   @relation("ExpenseUpdater")
  createdIncomes      Income[]    @relation("IncomeCreator")
  updatedIncomes      Income[]    @relation("IncomeUpdater")
  responsibleServices Service[]   @relation("ServiceResponsible")
  managedSites        Site[]      @relation("SiteAccountManager")
  createdSites        Site[]      @relation("SiteCreator")
  department          Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  role                Role        @relation(fields: [roleId], references: [id])
  uploadedContracts   ContractDocument[]   @relation("ContractUploader")
  uploadedCloseoutDocs CloseoutDocument[]   @relation("CloseoutDocUploader")
  periodReports       WorkPeriodReport[]   @relation("PeriodReportAM")
  createdInvoices     Invoice[]            @relation("InvoiceCreator")
  createdPayments     Payment[]             @relation("PaymentCreator")

  @@index([departmentId])
  @@index([roleId])
}

model LegalEntity {
  id                    String          @id @default(uuid())
  name                  String          @unique
  type                  LegalEntityType
  usnPercent            Float           @default(0)
  vatPercent            Float           @default(0)
  isActive              Boolean         @default(true)
  generalDirector       String?
  activityBasis         String?
  legalAddress         String?
  inn                   String?
  kpp                   String?
  ogrn                  String?
  rs                    String?
  bankName              String?
  bik                   String?
  ks                    String?
  paymentInfo           String?
  generateClosingDocs   Boolean         @default(false)
  closingDocPerInvoice  Boolean?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  clients               Client[]
  incomes               Income[]
  expenses              Expense[]
  invoices              Invoice[]

  @@index([isActive])
  @@map("LegalEntity")
}

enum AgentSource {
  PARTNER
  AGENT
  REFERRER
  EMPLOYEE
}

enum AgentStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

model Agent {
  id                      String       @id @default(uuid())
  name                    String
  companyName             String?
  professionalActivity    String?
  phone                   String?
  telegram                String?
  position                String?
  commissionOnTop         Boolean      @default(false)
  commissionInOurAmount   Boolean      @default(false)
  desiredCommissionPercent Float?
  sellsOnBehalfOfCompany  Boolean      @default(false)
  transfersForClosingToUs Boolean      @default(false)
  description             String?
  source                  AgentSource?
  status                  AgentStatus  @default(ACTIVE)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  clients                 Client[]

  @@index([name])
  @@index([phone])
  @@index([telegram])
  @@index([status])
}

model Client {
  id                String          @id @default(uuid())
  name              String
  legalEntityId     String?
  sellerEmployeeId  String
  agentId           String?
  legalEntityName   String?
  contractBasis     String?
  legalAddress     String?
  inn               String?
  kpp               String?
  ogrn              String?
  rs                String?
  bankName          String?
  bik               String?
  ks                String?
  paymentRequisites String?
  contacts          String?
  isReturningClient Boolean         @default(false)
  isKeyClient       Boolean         @default(false)
  keyClientStatusComment    String?
  returningClientStatusComment String?
  isSystem          Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  legalEntity       LegalEntity?    @relation(fields: [legalEntityId], references: [id])
  seller            User            @relation("ClientSeller", fields: [sellerEmployeeId], references: [id])
  agent             Agent?          @relation(fields: [agentId], references: [id], onDelete: SetNull)
  sites             Site[]
  contractDocuments ContractDocument[]
  closeoutPackages  CloseoutPackage[]
  closeoutDocuments CloseoutDocument[]
  clientContacts    ClientContact[]

  @@index([sellerEmployeeId])
  @@index([legalEntityId])
  @@index([agentId])
  @@index([sellerEmployeeId, isSystem])
}

enum ContactRoleAtClient {
  OWNER
  MARKETING
  FINANCE
  IT
  OTHER
}

model Contact {
  id          String          @id @default(uuid())
  name        String
  phone1      String?
  phone2      String?
  birthDate   DateTime?
  telegram    String?
  whatsapp    String?
  position    String?
  note        String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  clientLinks ClientContact[]

  @@index([name])
  @@index([phone1])
  @@index([telegram])
  @@index([whatsapp])
}

model ClientContact {
  id         String            @id @default(uuid())
  clientId   String
  contactId  String
  role       ContactRoleAtClient? @default(OTHER)
  isPrimary  Boolean           @default(false)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  client     Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contact    Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([clientId, contactId])
  @@index([clientId])
  @@index([contactId])
}

model Product {
  id        String    @id @default(uuid())
  name      String    @unique
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  services  Service[]

  @@index([sortOrder])
}

model Site {
  id               String    @id @default(uuid())
  title            String
  websiteUrl       String?
  description      String?
  isActive         Boolean   @default(false)
  niche            String
  clientId         String
  accountManagerId String?
  creatorId        String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  expenses         Expense[]
  services         Service[]
  accountManager   User?     @relation("SiteAccountManager", fields: [accountManagerId], references: [id])
  client           Client    @relation(fields: [clientId], references: [id])
  creator          User      @relation("SiteCreator", fields: [creatorId], references: [id])
  contractDocuments ContractDocument[]
  contractSections  ContractSection[]
  closeoutPackages  CloseoutPackage[]

  @@index([clientId])
  @@index([accountManagerId])
  @@index([creatorId])
  @@index([isActive])
  @@index([clientId, isActive])
  @@map("Site")
}

model Service {
  id                String        @id @default(uuid())
  siteId            String
  productId         String
  status            ServiceStatus @default(ACTIVE)
  startDate         DateTime
  endDate           DateTime?
  billingType       BillingType
  price             BigInt?
  autoRenew         Boolean       @default(false)
  responsibleUserId String?
  comment           String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  expenses          Expense[]
  incomes           Income[]
  product           Product       @relation(fields: [productId], references: [id])
  responsible       User?         @relation("ServiceResponsible", fields: [responsibleUserId], references: [id])
  site              Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  closeoutPackages  CloseoutPackage[]
  workPeriods      WorkPeriod[]

  @@index([siteId])
  @@index([productId])
  @@index([status])
  @@index([responsibleUserId])
  @@index([siteId, status])
  @@map("Service")
}

enum WorkPeriodType {
  STANDARD
  EXTENDED
  BONUS
  COMPENSATION
}

enum PeriodReportPaymentType {
  PREPAY
  POSTPAY
  FRACTIONAL
}

model WorkPeriod {
  id                  String           @id @default(uuid())
  serviceId           String
  dateFrom            DateTime
  dateTo              DateTime
  periodType          WorkPeriodType   @default(STANDARD)
  invoiceNotRequired  Boolean          @default(false)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  service             Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  invoices            Invoice[]
  incomes             Income[]
  periodReport        WorkPeriodReport?
  closeoutDocuments   CloseoutDocument[]

  @@index([serviceId])
  @@index([dateFrom, dateTo])
  @@map("WorkPeriod")
}

model WorkPeriodReport {
  id               String                   @id @default(uuid())
  workPeriodId     String                   @unique
  filePath         String
  originalName     String
  mimeType         String?
  sizeBytes        Int?
  paymentType      PeriodReportPaymentType
  accountManagerId String
  completedAt      DateTime                 @default(now())
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  workPeriod       WorkPeriod               @relation(fields: [workPeriodId], references: [id], onDelete: Cascade)
  accountManager   User                     @relation("PeriodReportAM", fields: [accountManagerId], references: [id])

  @@index([workPeriodId])
  @@index([accountManagerId])
  @@map("WorkPeriodReport")
}

model Invoice {
  id                          String    @id @default(uuid())
  workPeriodId                String
  amount                      BigInt
  coverageFrom                DateTime?
  coverageTo                  DateTime?
  invoiceNumber               String?
  legalEntityId               String
  generateClosingDocsAtInvoice Boolean  @default(false)
  closingDocPerInvoiceAtInvoice Boolean?
  invoiceNotRequired          Boolean   @default(false)
  createdAt                   DateTime  @default(now())
  createdByUserId             String?
  updatedAt                   DateTime  @updatedAt
  workPeriod                  WorkPeriod @relation(fields: [workPeriodId], references: [id], onDelete: Cascade)
  legalEntity                 LegalEntity @relation(fields: [legalEntityId], references: [id])
  creator                     User?     @relation("InvoiceCreator", fields: [createdByUserId], references: [id])
  payments                    Payment[]
  closeoutDocuments           CloseoutDocument[]

  @@index([workPeriodId])
  @@index([legalEntityId])
  @@index([createdByUserId])
  @@map("Invoice")
}

model Payment {
  id              String   @id @default(uuid())
  invoiceId       String
  amount          BigInt
  paidAt          DateTime @default(now())
  comment         String?
  createdByUserId String
  createdAt       DateTime @default(now())
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  creator         User     @relation("PaymentCreator", fields: [createdByUserId], references: [id])

  @@index([invoiceId])
  @@index([createdByUserId])
  @@index([paidAt])
  @@map("Payment")
}

model Income {
  id              String       @id @default(uuid())
  amount          BigInt
  serviceId       String
  workPeriodId    String?
  legalEntityId   String?
  comment         String?
  incomeDate      DateTime     @default(now())
  createdByUserId String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime?
  updatedByUserId String?
  creator         User         @relation("IncomeCreator", fields: [createdByUserId], references: [id])
  legalEntity     LegalEntity? @relation(fields: [legalEntityId], references: [id])
  service         Service      @relation(fields: [serviceId], references: [id])
  workPeriod      WorkPeriod?  @relation(fields: [workPeriodId], references: [id], onDelete: SetNull)
  updater         User?        @relation("IncomeUpdater", fields: [updatedByUserId], references: [id])

  @@index([serviceId])
  @@index([workPeriodId])
  @@index([createdByUserId])
  @@index([incomeDate])
  @@index([legalEntityId])
  @@index([createdAt])
  @@index([createdByUserId, createdAt])
}

model CostCategory {
  id        String     @id @default(uuid())
  name      String     @unique
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  costItems CostItem[]

  @@index([sortOrder])
}

model FinancialModelExpenseType {
  id        String     @id @default(uuid())
  name      String     @unique
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  costItems CostItem[]

  @@index([sortOrder])
}

model Niche {
  id        String   @id @default(uuid())
  name      String   @unique
  parentId  String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  parent    Niche?   @relation("NicheHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Niche[]  @relation("NicheHierarchy")

  @@index([sortOrder])
  @@index([parentId])
}

model CostItem {
  id                         String                     @id @default(uuid())
  costCategoryId             String
  title                      String
  sortOrder                  Int                        @default(0)
  financialModelExpenseTypeId String
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  costCategory               CostCategory               @relation(fields: [costCategoryId], references: [id], onDelete: Restrict)
  financialModelExpenseType  FinancialModelExpenseType  @relation(fields: [financialModelExpenseTypeId], references: [id], onDelete: Restrict)
  expenses                   Expense[]

  @@index([costCategoryId])
  @@index([financialModelExpenseTypeId])
  @@index([sortOrder])
}

model Expense {
  id               String       @id @default(uuid())
  amount           BigInt
  costItemId       String
  title            String?
  employeeId       String?
  siteId           String?
  serviceId        String?
  legalEntityId    String?
  comment          String?
  createdByUserId  String
  createdAt        DateTime     @default(now())
  paymentAt        DateTime     @default(now())
  updatedAt        DateTime?
  updatedByUserId  String?
  costItem         CostItem     @relation(fields: [costItemId], references: [id])
  creator          User         @relation("ExpenseCreator", fields: [createdByUserId], references: [id])
  employee         User?        @relation("ExpenseEmployee", fields: [employeeId], references: [id])
  service          Service?     @relation(fields: [serviceId], references: [id])
  site             Site?        @relation(fields: [siteId], references: [id])
  legalEntity      LegalEntity? @relation(fields: [legalEntityId], references: [id])
  updater          User?        @relation("ExpenseUpdater", fields: [updatedByUserId], references: [id])

  @@index([costItemId])
  @@index([employeeId])
  @@index([siteId])
  @@index([serviceId])
  @@index([legalEntityId])
  @@index([createdByUserId])
  @@index([paymentAt])
  @@index([createdAt])
  @@index([createdByUserId, paymentAt])
}

// ——— Хранилище: Договора ———
enum ContractDocType {
  CONTRACT
  ADDENDUM
  NDA
  OTHER
}

enum ContractStatus {
  ACTIVE
  CLOSED
}

model ContractDocument {
  id              String          @id @default(uuid())
  clientId        String
  siteId          String?
  type            ContractDocType @default(CONTRACT)
  parentId        String?
  filePath        String
  originalName    String
  mimeType        String?
  sizeBytes       Int?
  docNumber       String?
  docDate         DateTime?
  endDate         DateTime?
  comment         String?
  tags            String?
  status          ContractStatus  @default(ACTIVE)
  uploadedById    String
  uploadedAt      DateTime        @default(now())
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  site            Site?           @relation(fields: [siteId], references: [id], onDelete: SetNull)
  uploader        User            @relation("ContractUploader", fields: [uploadedById], references: [id])
  sections        ContractSection[]
  children        ContractDocument[] @relation("ContractChildren")
  parent          ContractDocument?  @relation("ContractChildren", fields: [parentId], references: [id])

  @@index([clientId])
  @@index([siteId])
  @@index([uploadedById])
  @@index([status])
  @@index([uploadedAt])
}

model ContractSection {
  id          String           @id @default(uuid())
  contractId  String
  title       String
  comment     String?
  siteId      String?
  serviceId   String?
  contract    ContractDocument @relation(fields: [contractId], references: [id], onDelete: Cascade)
  site        Site?            @relation(fields: [siteId], references: [id], onDelete: SetNull)

  @@index([contractId])
}

enum CloseoutPeriodType {
  MONTH
  STAGE
  ONE_TIME
}

enum CloseoutPackageStatus {
  PREPARING
  SENT
  SIGNED
}

enum CloseoutDocType {
  ACT
  INVOICE
  SF
  UPD
  RECONCILIATION
  REPORT
  OTHER
}

enum CloseoutDocStatus {
  DRAFT
  SIGNED
}

model CloseoutPackage {
  id          String                @id @default(uuid())
  clientId    String
  siteId      String?
  serviceId   String?
  period      String
  periodType  CloseoutPeriodType    @default(MONTH)
  amount      BigInt?
  status      CloseoutPackageStatus @default(PREPARING)
  client      Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  site        Site?                 @relation(fields: [siteId], references: [id], onDelete: SetNull)
  service     Service?              @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  documents   CloseoutDocument[]

  @@index([clientId])
  @@index([period])
  @@index([status])
}

model CloseoutDocument {
  id            String            @id @default(uuid())
  packageId     String?
  clientId      String
  period        String?
  workPeriodId  String?
  invoiceId     String?
  docType       CloseoutDocType    @default(ACT)
  filePath      String
  originalName  String
  mimeType      String?
  sizeBytes     Int?
  docDate       DateTime?
  amount        BigInt?
  status        CloseoutDocStatus   @default(DRAFT)
  comment       String?
  uploadedById  String
  uploadedAt    DateTime          @default(now())
  package       CloseoutPackage?   @relation(fields: [packageId], references: [id], onDelete: SetNull)
  client        Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  uploader      User              @relation("CloseoutDocUploader", fields: [uploadedById], references: [id])
  workPeriod    WorkPeriod?       @relation(fields: [workPeriodId], references: [id], onDelete: SetNull)
  invoice       Invoice?          @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([packageId])
  @@index([period])
  @@index([uploadedById])
  @@index([workPeriodId])
  @@index([invoiceId])
}

enum LegalEntityType {
  IP
  OOO
  CARD
  CRYPTO
  BARTER
}

enum ServiceStatus {
  ACTIVE
  PAUSED
  FINISHED
}

enum BillingType {
  ONE_TIME
  MONTHLY
  QUARTERLY
  YEARLY
}

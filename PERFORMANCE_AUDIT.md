# Аудит производительности и оптимизация

## Дата: 2026-01-21

---

## 1. КРИТИЧЕСКИЕ ПРОБЛЕМЫ (N+1, тяжелые запросы)

### 1.1 N+1 в отчете по сотрудникам ⚠️ КРИТИЧНО
**Файл**: `app/api/reports/employees/route.ts`
**Проблема**: Для каждого сотрудника делается 2 отдельных запроса (incomes и expenses)
```typescript
// ТЕКУЩИЙ КОД (ПЛОХО):
const report = await Promise.all(
  employees.map(async (emp) => {
    const incomes = await prisma.income.findMany({ ... });  // N запросов
    const expenses = await prisma.expense.findMany({ ... }); // N запросов
  })
);
```
**Решение**: Использовать группировку через SQL aggregate или один запрос с группировкой

### 1.2 Агрегация на клиенте вместо БД ⚠️ СРЕДНЕ
**Файлы**: 
- `app/api/reports/incomes/route.ts` (строка 138)
- `app/api/reports/expenses/route.ts` (строка 106)
**Проблема**: `total` считается через `reduce()` на клиенте после загрузки всех данных
```typescript
// ТЕКУЩИЙ КОД (ПЛОХО):
const total = incomes.reduce((sum, inc) => sum + Number(inc.amount), 0);
```
**Решение**: Использовать `prisma.income.aggregate({ _sum: { amount: true } })`

### 1.3 Отсутствие пагинации ⚠️ СРЕДНЕ
**Файлы**: Все API endpoints для списков
**Проблема**: Загружаются все записи без ограничений (`take: 100` только в некоторых местах)
**Решение**: Добавить пагинацию с `skip` и `take`, передавать на клиент

### 1.4 Отчеты загружают все данные ⚠️ СРЕДНЕ
**Файлы**: `app/api/reports/incomes/route.ts`, `app/api/reports/expenses/route.ts`
**Проблема**: Нет ограничений на количество записей, может быть тысячи
**Решение**: Добавить лимит или пагинацию

---

## 2. ПРОБЛЕМЫ БАЗЫ ДАННЫХ

### 2.1 Отсутствующие индексы
**Проблема**: Некоторые часто используемые поля не индексированы
**Нужно добавить**:
- `Income.createdAt` - для фильтрации по дате создания
- `Expense.createdAt` - для фильтрации по дате создания
- `Service.siteId + status` - составной индекс для фильтров
- `Site.clientId + isActive` - составной индекс для фильтров
- `Client.sellerEmployeeId + isSystem` - составной индекс

### 2.2 Неоптимальные запросы
**Проблема**: В некоторых местах загружаются лишние поля
**Пример**: В отчетах загружается полный объект `creator` вместо только `fullName`

---

## 3. ПРОБЛЕМЫ FRONTEND

### 3.1 Дублирование запросов пользователя
**Проблема**: Каждый компонент вызывает `fetch('/api/auth/me')` отдельно
**Файлы**: Почти все компоненты списков
**Решение**: Вынести в общий контекст или использовать server-side props

### 3.2 Отсутствие мемоизации
**Проблема**: Фильтры пересчитываются при каждом рендере
**Решение**: Использовать `useMemo` для вычисляемых значений

### 3.3 Отсутствие debounce для поиска
**Проблема**: При вводе в фильтры сразу делается запрос
**Решение**: Добавить debounce (300-500ms)

### 3.4 Большие списки без виртуализации
**Проблема**: Рендерятся все строки таблицы сразу
**Решение**: Добавить виртуализацию для списков > 100 элементов

### 3.5 Лишние ререндеры
**Проблема**: Компоненты перерендериваются при изменении несвязанных состояний
**Решение**: Использовать `React.memo` и `useCallback`

---

## 4. ПРОБЛЕМЫ КОДА

### 4.1 Много console.log
**Проблема**: 68 вхождений `console.log/error/warn` в API routes
**Решение**: Удалить или заменить на структурированное логирование

### 4.2 Дублирование проверок прав
**Проблема**: Проверки прав дублируются в разных местах
**Решение**: Унифицировать через единую функцию

### 4.3 Неиспользуемый код
**Проблема**: Возможны неиспользуемые компоненты/утилиты
**Решение**: Проверить и удалить

---

## 5. ПЛАН ИСПРАВЛЕНИЙ

### Приоритет 1 (Критично):
1. ✅ Исправить N+1 в отчете по сотрудникам
2. ✅ Заменить агрегацию на SQL aggregate
3. ✅ Добавить индексы в схему БД

### Приоритет 2 (Важно):
4. ✅ Добавить пагинацию в API endpoints
5. ✅ Оптимизировать запросы (убрать лишние поля)
6. ✅ Добавить debounce для фильтров

### Приоритет 3 (Улучшения):
7. ✅ Убрать дублирование запросов пользователя
8. ✅ Добавить мемоизацию
9. ✅ Удалить console.log
10. ✅ Унифицировать проверки прав

---

## 6. ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ

### До оптимизации:
- Отчет по доходам (30 дней): ~XXXms
- Отчет по сотрудникам (30 дней): ~XXXms
- Загрузка страницы "Доходы": ~XXXms
- Загрузка модалки "Добавить доход": ~XXXms

### После оптимизации:
- Отчет по доходам (30 дней): ~XXXms (улучшение: X%)
- Отчет по сотрудникам (30 дней): ~XXXms (улучшение: X%)
- Загрузка страницы "Доходы": ~XXXms (улучшение: X%)
- Загрузка модалки "Добавить доход": ~XXXms (улучшение: X%)

# Архитектура и логика работы системы "Финансы агентства"

## 1. Общая архитектура системы

### 1.1 Технологический стек
- **Frontend**: Next.js 14 (App Router) + TypeScript + Tailwind CSS
- **Backend**: Next.js API Routes (Route Handlers)
- **Database**: PostgreSQL + Prisma ORM
- **Authentication**: Парольная авторизация с httpOnly cookie-сессиями
- **Password hashing**: bcryptjs

### 1.2 Бизнес-модель данных

Система построена на иерархической модели:

```
Client (Клиент)
  └── Site (Сайт)
      └── Service (Услуга)
          ├── Income (Доход) - ОБЯЗАТЕЛЬНО привязан к услуге
          └── Expense (Расход) - ОПЦИОНАЛЬНО привязан к услуге
```

**Ключевые принципы:**
- Один клиент может иметь множество сайтов
- Один сайт может иметь множество услуг
- Доход **обязательно** привязан к услуге (через `serviceId`)
- Расход может быть привязан к услуге (опционально) или только к сайту
- Продукты используются как справочник для создания услуг

---

## 2. Система прав доступа (RBAC)

### 2.1 Роли и их уровни доступа

#### Системные роли (нельзя удалить):
- **OWNER (Владелец)**: Полный доступ ко всем разделам, включая управление ролями
- **CEO**: Полный доступ ко всем разделам, кроме управления ролями

#### Пользовательские роли (настраиваемые):
- **HEAD_ACCOUNTING (Старший Аккаунт)**: Управление сайтами, доходами, расходами
- **FINANCE (Финансист)**: Просмотр и редактирование финансовых данных
- **ACCOUNT_MANAGER (Аккаунт-менеджер)**: Управление своими сайтами и услугами
- **SELLER (Продавец)**: Просмотр и добавление доходов только для своих клиентов
- **HEAD (Руководитель отдела)**: Управление сотрудниками своего отдела
- **EMPLOYEE (Сотрудник)**: Базовые права просмотра
- **CONTRACTOR (Подрядчик)**: Ограниченные права

### 2.2 Система разрешений

Разрешения задаются на уровне:
- **Section** (раздел): `sites`, `clients`, `incomes`, `expenses`, `employees`, `products`, `reports`, `roles`, `services`, `legal-entities`
- **Permission** (действие): `view`, `create`, `edit`, `delete`, `manage`

**Логика проверки:**
1. OWNER имеет все права всегда
2. CEO имеет все права, кроме раздела `roles`
3. Разрешение `manage` включает все остальные (`view`, `create`, `edit`, `delete`)
4. Для конкретных действий проверяется наличие соответствующего разрешения

### 2.3 Контекстные ограничения доступа

#### Аккаунт-менеджер (ACCOUNT_MANAGER):
- Видит только сайты, где он является `accountManagerId` или `creatorId`
- Может создавать/редактировать услуги только для своих сайтов
- Может добавлять доходы только для услуг своих сайтов

#### Продавец (SELLER):
- Видит только сайты своих клиентов (где `client.sellerEmployeeId === user.id`)
- Может добавлять доходы только для услуг сайтов своих клиентов

#### Руководитель отдела (HEAD):
- Может управлять (добавлять/редактировать/удалять) сотрудниками только своего отдела
- Видит всех сотрудников, но редактировать может только своих

---

## 3. Разделы системы и их логика

### 3.1 Услуги (Services) - Главный раздел

**Путь**: `/services`

**Назначение**: Центральный раздел для управления услугами. Является точкой входа для аккаунт-менеджеров.

**Основные функции:**
- Просмотр всех услуг с фильтрацией по статусу и сайту
- Создание новой услуги (с выбором сайта)
- Редактирование услуги
- Удаление услуги (только если нет связанных доходов)

**Поля услуги:**
- `siteId` - Сайт (обязательно)
- `productId` - Продукт из справочника (обязательно)
- `status` - Статус: ACTIVE, PAUSED, FINISHED
- `startDate` - Дата начала
- `endDate` - Дата окончания (опционально)
- `billingType` - Тип биллинга: ONE_TIME, MONTHLY, QUARTERLY, YEARLY
- `price` - Цена (в копейках, BigInt, опционально)
- `autoRenew` - Автопродление (булево)
- `responsibleUserId` - Ответственный сотрудник (опционально)
- `comment` - Комментарий

**Логика доступа:**
- OWNER, CEO, FINANCE: видят все услуги
- ACCOUNT_MANAGER: видят услуги только своих сайтов
- SELLER: видят услуги только сайтов своих клиентов

**Взаимосвязи:**
- Связана с `Site` (обязательно)
- Связана с `Product` (обязательно)
- Может иметь множество `Income` (доходы)
- Может иметь множество `Expense` (расходы)

---

### 3.2 Сайты (Sites) - Бывшие "Проекты"

**Путь**: `/sites`

**Назначение**: Управление сайтами клиентов. Каждый сайт принадлежит клиенту и может иметь множество услуг.

**Основные функции:**
- Просмотр списка сайтов с фильтрацией
- Создание нового сайта
- Редактирование сайта
- Удаление сайта (каскадно удаляет все услуги)
- Просмотр услуг сайта во вкладке "Услуги"

**Поля сайта:**
- `title` - Название сайта
- `websiteUrl` - URL сайта (опционально)
- `description` - Описание (опционально)
- `isActive` - Активен ли сайт
- `niche` - Ниша (текстовое поле)
- `clientId` - Клиент (обязательно)
- `accountManagerId` - Аккаунт-менеджер (опционально)
- `creatorId` - Создатель сайта

**Логика доступа:**
- OWNER, CEO, FINANCE: видят все сайты
- ACCOUNT_MANAGER: видят сайты, где он `accountManagerId` или `creatorId`
- SELLER: видят сайты своих клиентов

**Особенности:**
- При редактировании сайта пользователем без прав `sites:manage`, поле `accountManagerId` не изменяется (сохраняется текущее значение)
- Удаление сайта каскадно удаляет все связанные услуги

**Взаимосвязи:**
- Принадлежит `Client` (обязательно)
- Имеет множество `Service` (услуг)
- Может иметь множество `Expense` (расходов)
- Может иметь `accountManager` (User)

---

### 3.3 Клиенты (Clients)

**Путь**: `/clients`

**Назначение**: Управление клиентами агентства. Каждый клиент имеет продавца и может иметь множество сайтов.

**Основные функции:**
- Просмотр списка клиентов
- Создание нового клиента
- Редактирование клиента
- Удаление клиента (все сайты переносятся в "Без клиентов")

**Поля клиента:**
- `name` - Название клиента
- `legalEntityId` - Юридическое лицо (опционально)
- `sellerEmployeeId` - Продавец (обязательно)
- Юридические реквизиты (если `legalEntity.type` = IP или OOO):
  - `legalEntityName`, `contractBasis`, `legalAddress`, `inn`, `kpp`, `ogrn`, `rs`, `bankName`, `bik`, `ks`
- `paymentRequisites` - Платежные реквизиты (текстовое поле)
- `contacts` - Контакты

**Логика доступа:**
- OWNER, CEO, FINANCE, HEAD_ACCOUNTING: полный доступ
- SELLER: может создавать клиентов и видеть своих клиентов
- Остальные: только просмотр (если есть разрешение `clients:view`)

**Особенности:**
- Системный клиент "Без клиентов" (`isSystem = true`) используется для сайтов без клиента
- При удалении клиента все его сайты переносятся в "Без клиентов"

**Взаимосвязи:**
- Имеет множество `Site` (сайтов)
- Принадлежит `LegalEntity` (опционально)
- Имеет `seller` (User - продавец)

---

### 3.4 Доходы (Incomes)

**Путь**: `/incomes`

**Назначение**: Учет доходов от услуг. Каждый доход **обязательно** привязан к услуге.

**Основные функции:**
- Просмотр списка доходов с фильтрацией
- Создание нового дохода (обязательно выбирается услуга)
- Редактирование дохода (OWNER, CEO могут менять дату)
- Удаление дохода (только OWNER, CEO)

**Поля дохода:**
- `amount` - Сумма (в копейках, BigInt)
- `serviceId` - Услуга (**обязательно**)
- `legalEntityId` - Юридическое лицо (опционально)
- `comment` - Комментарий
- `incomeDate` - Дата дохода (по умолчанию - текущая дата)
- `createdByUserId` - Создатель
- `updatedByUserId` - Обновивший (если редактировался)

**Логика доступа:**
- OWNER, CEO, FINANCE: видят все доходы
- ACCOUNT_MANAGER: видят доходы только для услуг своих сайтов
- SELLER: видят доходы только для услуг сайтов своих клиентов, могут добавлять доходы

**Особенности:**
- Доход **не может быть создан без услуги** - это ключевое бизнес-правило
- При создании дохода автоматически определяется клиент и сайт через услугу
- OWNER и CEO могут изменять дату дохода при редактировании

**Взаимосвязи:**
- Привязан к `Service` (обязательно)
- Через услугу связан с `Site` и `Client`
- Может быть привязан к `LegalEntity` (опционально)

---

### 3.5 Расходы (Expenses)

**Путь**: `/expenses`

**Назначение**: Учет расходов агентства. Расход может быть привязан к услуге (опционально) или только к сайту.

**Основные функции:**
- Просмотр списка расходов с фильтрацией
- Создание нового расхода (быстрая форма и полная форма)
- Редактирование расхода (OWNER, CEO могут менять дату)
- Удаление расхода (только OWNER, CEO)

**Поля расхода:**
- `amount` - Сумма (в копейках, BigInt)
- `costItemId` - Статья расхода (обязательно)
- `employeeId` - Сотрудник (опционально)
- `siteId` - Сайт (опционально)
- `serviceId` - Услуга (опционально)
- `paymentAt` - Дата оплаты (по умолчанию - текущая дата)
- `createdByUserId` - Создатель
- `updatedByUserId` - Обновивший (если редактировался)

**Логика доступа:**
- OWNER, CEO, FINANCE: видят все расходы
- Остальные: в зависимости от разрешений `expenses:view`

**Особенности:**
- Расход может быть общим (без привязки к сайту/услуге) или привязанным к конкретной услуге
- OWNER и CEO могут изменять дату оплаты при редактировании
- Категории расходов: SALARY, SALES_PERCENT, OFFICE, HR, AGENCY_PAYMENTS, SERVICES, LINKS, CONTRACTOR, OTHER

**Взаимосвязи:**
- Привязан к `CostItem` (обязательно)
- Может быть привязан к `Site` (опционально)
- Может быть привязан к `Service` (опционально)
- Может быть привязан к `User` (employee)

---

### 3.6 Команда (Employees) - Бывшие "Сотрудники"

**Путь**: `/employees` (в меню "Настройки")

**Назначение**: Управление сотрудниками агентства, их отделами и ролями.

**Основные функции:**
- Просмотр списка сотрудников, сгруппированных по отделам
- Создание нового сотрудника
- Редактирование сотрудника (включая смену пароля)
- Удаление сотрудника (постоянное удаление с переназначением данных)

**Поля сотрудника:**
- `fullName` - Полное имя
- `departmentId` - Отдел (опционально)
- `roleId` - Роль (обязательно)
- `passwordHash` - Хеш пароля (bcrypt)
- `isActive` - Активен ли сотрудник

**Логика доступа:**
- OWNER, CEO: полный доступ ко всем сотрудникам
- HEAD (Руководитель отдела): может управлять сотрудниками только своего отдела
- Остальные: в зависимости от разрешений `employees:view`

**Особенности:**
- Руководители отделов отображаются вверху списка своего отдела и подсвечиваются
- Неактивные сотрудники отображаются внизу списка своего отдела
- При удалении сотрудника:
  - Все его сайты переносятся к OWNER
  - Все его клиенты переносятся к OWNER
  - Сотрудник удаляется из базы данных (не деактивируется)

**Взаимосвязи:**
- Принадлежит `Department` (опционально)
- Имеет `Role` (обязательно)
- Может быть руководителем отдела (`Department.head`)
- Может быть продавцом клиентов (`Client.seller`)
- Может быть аккаунт-менеджером сайтов (`Site.accountManager`)

---

### 3.7 Продукты (Products)

**Путь**: `/products` (в меню "Настройки")

**Назначение**: Справочник продуктов/услуг. Используется при создании услуг.

**Основные функции:**
- Просмотр списка продуктов с возможностью переупорядочивания (drag-n-drop)
- Создание нового продукта
- Редактирование продукта
- Удаление продукта (только если не используется в услугах)
- Переупорядочивание продуктов (только OWNER, CEO)

**Поля продукта:**
- `name` - Название продукта
- `sortOrder` - Порядок сортировки (используется для drag-n-drop)

**Логика доступа:**
- OWNER, CEO: полный доступ, включая переупорядочивание
- Остальные: в зависимости от разрешений `products:view/create/edit/delete`

**Особенности:**
- Порядок продуктов (`sortOrder`) сохраняется и используется во всех списках
- Продукт нельзя удалить, если он используется хотя бы в одной услуге

**Взаимосвязи:**
- Используется в `Service` (множество услуг могут использовать один продукт)

---

### 3.8 Роли (Roles)

**Путь**: `/roles` (в меню "Настройки")

**Назначение**: Управление ролями и их разрешениями. Доступно только OWNER и CEO.

**Основные функции:**
- Просмотр списка ролей
- Создание новой роли
- Редактирование роли и её разрешений
- Удаление роли (системные роли нельзя удалить)

**Поля роли:**
- `name` - Название роли
- `code` - Код роли (уникальный, например: OWNER, CEO, ACCOUNT_MANAGER)
- `isSystem` - Системная роль (нельзя удалить)
- Разрешения (`RolePermission`):
  - `section` - Раздел (sites, clients, incomes, expenses, employees, products, reports, roles, services, legal-entities)
  - `permission` - Действие (view, create, edit, delete, manage)

**Логика доступа:**
- OWNER: полный доступ, включая управление ролями
- CEO: не имеет доступа к разделу ролей
- Остальные: нет доступа

**Особенности:**
- Системные роли (OWNER, CEO) нельзя удалить (`isSystem = true`)
- Разрешение `manage` включает все остальные разрешения (`view`, `create`, `edit`, `delete`)

**Взаимосвязи:**
- Имеет множество `User` (пользователей с этой ролью)
- Имеет множество `RolePermission` (разрешений)

---

### 3.9 Юридические лица (Legal Entities)

**Путь**: `/legal-entities` (в меню "Настройки")

**Назначение**: Справочник юридических лиц для оплаты. Используется при создании клиентов и доходов.

**Основные функции:**
- Просмотр списка юридических лиц
- Создание нового юридического лица
- Редактирование юридического лица
- Удаление юридического лица (только если не используется)

**Поля юридического лица:**
- `name` - Название
- `type` - Тип: IP, OOO, CARD, CRYPTO, BARTER
- `usnPercent` - Процент УСН
- `vatPercent` - Процент НДС
- `isActive` - Активно ли

**Для IP и OOO:**
- `generalDirector` - Генеральный директор (только для OOO)
- `activityBasis` - Основание деятельности (только для OOO)
- `legalAddress`, `inn`, `kpp`, `ogrn`, `rs`, `bankName`, `bik`, `ks` - Юридические реквизиты

**Для остальных типов:**
- `paymentInfo` - Информация о способе оплаты

**Логика доступа:**
- OWNER, CEO: полный доступ
- Остальные: только просмотр активных юридических лиц (для выбора в формах)

**Особенности:**
- В формах создания/редактирования клиентов и доходов отображаются только активные юридические лица
- Юридическое лицо нельзя удалить, если оно используется в клиентах или доходах

**Взаимосвязи:**
- Используется в `Client` (множество клиентов могут использовать одно юридическое лицо)
- Используется в `Income` (множество доходов могут использовать одно юридическое лицо)

---

### 3.10 Отчеты (Reports)

**Путь**: `/reports`

**Назначение**: Генерация финансовых отчетов по доходам, расходам и сотрудникам.

**Основные функции:**
- Генерация отчета по доходам
- Генерация отчета по расходам
- Генерация отчета по сотрудникам
- Экспорт отчетов в CSV

**Типы отчетов:**

#### 3.10.1 Отчет по доходам
- Фильтры: дата от/до, аккаунт-менеджер, продавец, сайт, услуга, продукт, клиент, юридическое лицо
- Показывает: дату, сумму, клиента, сайт, услугу (продукт), юридическое лицо
- Итоги: общая сумма и количество записей

#### 3.10.2 Отчет по расходам
- Фильтры: дата от/до, категория, аккаунт-менеджер, продавец, сайт, услуга, клиент
- Показывает: дату, сумму, категорию, тип расхода, сайт, услугу, клиента
- Итоги: общая сумма и количество записей

#### 3.10.3 Отчет по сотрудникам
- Фильтры: дата от/до
- Показывает: сотрудника, отдел, количество доходов, сумму доходов, количество расходов, сумму расходов, разницу
- Показывает только сотрудников с активностью (есть доходы или расходы)

**Логика доступа:**
- OWNER, CEO, FINANCE, HEAD_ACCOUNTING: полный доступ ко всем отчетам
- ACCOUNT_MANAGER: видит отчеты только по своим сайтам
- SELLER: видит отчеты только по своим клиентам
- Остальные: в зависимости от разрешений `reports:view`

**Особенности:**
- Все суммы в отчетах конвертируются из BigInt (копейки) в рубли для отображения
- Отчеты можно экспортировать в CSV формат
- Фильтры применяются с учетом прав доступа пользователя

---

## 4. Взаимосвязи между разделами

### 4.1 Цепочка создания данных

**Типичный сценарий создания проекта:**

1. **Создание клиента** (`/clients`)
   - Выбирается продавец (`sellerEmployeeId`)
   - Выбирается юридическое лицо (опционально)
   - Заполняются юридические реквизиты (если нужно)

2. **Создание сайта** (`/sites`)
   - Выбирается клиент (`clientId`)
   - Выбирается аккаунт-менеджер (`accountManagerId`) - опционально
   - Указывается ниша и другая информация

3. **Создание услуги** (`/services` или в карточке сайта)
   - Выбирается сайт (`siteId`)
   - Выбирается продукт из справочника (`productId`)
   - Указываются даты, тип биллинга, цена, ответственный

4. **Создание дохода** (`/incomes`)
   - **Обязательно** выбирается услуга (`serviceId`)
   - Автоматически определяется клиент и сайт через услугу
   - Указывается сумма, юридическое лицо, дата, комментарий

5. **Создание расхода** (`/expenses`)
   - Выбирается статья расхода (`costItemId`)
   - Опционально выбирается сайт (`siteId`)
   - Опционально выбирается услуга (`serviceId`)
   - Указывается сумма, сотрудник, дата оплаты

### 4.2 Каскадные операции

**При удалении клиента:**
- Все сайты клиента переносятся в "Без клиентов"
- Клиент удаляется из базы

**При удалении сайта:**
- Все услуги сайта удаляются (каскадно)
- Все расходы, привязанные к сайту, остаются, но `siteId` становится `null`

**При удалении услуги:**
- Проверяется наличие доходов - если есть доходы, удаление запрещено
- Расходы, привязанные к услуге, остаются, но `serviceId` становится `null`

**При удалении сотрудника:**
- Все сайты сотрудника (где он `creatorId`) переносятся к OWNER
- Все клиенты сотрудника (где он `sellerEmployeeId`) переносятся к OWNER
- Сотрудник удаляется из базы данных

### 4.3 Фильтрация данных по правам доступа

**Аккаунт-менеджер видит:**
- Только свои сайты (где `accountManagerId === user.id` или `creatorId === user.id`)
- Только услуги своих сайтов
- Только доходы от услуг своих сайтов

**Продавец видит:**
- Только сайты своих клиентов (где `client.sellerEmployeeId === user.id`)
- Только услуги сайтов своих клиентов
- Только доходы от услуг сайтов своих клиентов

**Руководитель отдела видит:**
- Всех сотрудников, но может редактировать только сотрудников своего отдела

---

## 5. Потоки данных

### 5.1 Аутентификация

1. Пользователь вводит логин (полное имя) и пароль
2. Система ищет пользователя по `fullName`
3. Проверяется хеш пароля через `bcryptjs.compare()`
4. Создается сессия в базе данных (`Session`)
5. Устанавливается httpOnly cookie с `sessionId`
6. Пользователь перенаправляется на страницу по умолчанию:
   - ACCOUNT_MANAGER → `/services`
   - Остальные → `/sites` или `/clients`

### 5.2 Проверка прав доступа

1. При каждом запросе к API извлекается пользователь из сессии
2. Проверяется наличие разрешения через `hasPermission()`
3. Для контекстных ограничений (ACCOUNT_MANAGER, SELLER) применяются дополнительные фильтры в `where` условиях Prisma

### 5.3 Работа с денежными суммами

- **Хранение**: Все суммы хранятся в копейках как `BigInt` в базе данных
- **Ввод**: Пользователь вводит сумму в рублях (например, 1000.50)
- **Конвертация**: При сохранении сумма умножается на 100 и конвертируется в `BigInt`
- **Отображение**: При выводе `BigInt` конвертируется в строку, делится на 100 и форматируется как рубли
- **Сериализация**: При отправке через API все `BigInt` конвертируются в строки через `JSON.parse(JSON.stringify())`

### 5.4 Работа с датами

- **Доходы**: Используется поле `incomeDate` (дата дохода), по умолчанию - текущая дата
- **Расходы**: Используется поле `paymentAt` (дата оплаты), по умолчанию - текущая дата
- **Редактирование дат**: Только OWNER и CEO могут изменять даты при редактировании
- **Фильтрация**: В отчетах фильтрация происходит по `incomeDate` для доходов и `paymentAt` для расходов

---

## 6. Особенности реализации

### 6.1 Миграция данных

При переходе от старой модели (`Project` → `Site`, добавление `Service`):
- Создаются "Legacy" услуги для существующих доходов без услуги
- Старые доходы привязываются к Legacy услугам
- Данные не теряются

### 6.2 Drag-n-Drop для продуктов

- Порядок продуктов сохраняется в поле `sortOrder`
- При переупорядочивании отправляется запрос на `/api/products/reorder`
- Новый порядок применяется ко всем спискам продуктов в системе

### 6.3 Автопродление услуг

- Поле `autoRenew` хранится в базе данных
- В текущей версии автоматическая логика продления не реализована
- Планируется реализация через cron-задачи или проверку при загрузке страницы

### 6.4 Сериализация BigInt

- Все API endpoints, возвращающие данные с `BigInt`, используют `JSON.parse(JSON.stringify())` с replacer-функцией
- Это необходимо, так как JavaScript не может сериализовать `BigInt` напрямую в JSON

---

## 7. Структура файлов проекта

```
/
├── app/                    # Next.js App Router
│   ├── api/               # API Routes (Backend)
│   │   ├── auth/          # Аутентификация
│   │   ├── clients/       # Клиенты
│   │   ├── sites/         # Сайты
│   │   ├── services/      # Услуги
│   │   ├── incomes/       # Доходы
│   │   ├── expenses/      # Расходы
│   │   ├── employees/     # Сотрудники
│   │   ├── products/      # Продукты
│   │   ├── roles/         # Роли
│   │   ├── legal-entities/ # Юридические лица
│   │   └── reports/       # Отчеты
│   ├── clients/           # Страница клиентов
│   ├── sites/             # Страница сайтов
│   ├── services/          # Страница услуг
│   ├── incomes/           # Страница доходов
│   ├── expenses/          # Страница расходов
│   ├── employees/         # Страница сотрудников
│   ├── products/          # Страница продуктов
│   ├── roles/             # Страница ролей
│   ├── legal-entities/    # Страница юридических лиц
│   └── reports/            # Страница отчетов
├── components/            # React компоненты
│   ├── ClientsList.tsx    # Список клиентов
│   ├── SitesList.tsx      # Список сайтов
│   ├── ServicesList.tsx   # Список услуг (в карточке сайта)
│   ├── ServicesListAll.tsx # Список всех услуг
│   ├── IncomesList.tsx    # Список доходов
│   ├── ExpensesList.tsx   # Список расходов
│   ├── EmployeesList.tsx  # Список сотрудников
│   ├── ProductsList.tsx   # Список продуктов
│   ├── RolesList.tsx      # Список ролей
│   ├── LegalEntitiesList.tsx # Список юридических лиц
│   ├── ReportsList.tsx    # Отчеты
│   └── Navigation.tsx    # Навигация
├── lib/                   # Утилиты и библиотеки
│   ├── auth.ts           # Аутентификация
│   ├── permissions.ts    # Проверка прав доступа
│   ├── db.ts             # Prisma Client
│   ├── utils.ts          # Утилиты (форматирование сумм, дат)
│   └── csv.ts            # Генерация CSV
├── prisma/               # Prisma схема и миграции
│   ├── schema.prisma     # Схема базы данных
│   ├── seed.ts           # Начальные данные
│   └── migrate-legacy-data.ts # Миграция старых данных
└── middleware.ts         # Next.js middleware (проверка аутентификации)
```

---

## 8. Ключевые бизнес-правила

1. **Доход обязательно привязан к услуге** - это основа финансовой модели
2. **Расход может быть общим или привязанным к услуге** - для гибкости учета
3. **Аккаунт-менеджер видит только свои сайты** - для разделения ответственности
4. **Продавец видит только своих клиентов** - для конфиденциальности данных
5. **Руководитель отдела управляет только своим отделом** - для децентрализации управления
6. **Системные роли нельзя удалить** - для безопасности системы
7. **При удалении сотрудника данные переносятся к OWNER** - для сохранения целостности данных
8. **Все суммы хранятся в копейках** - для точности расчетов
9. **OWNER и CEO могут изменять даты** - для корректировки ошибок
10. **Услугу нельзя удалить, если есть доходы** - для сохранения финансовой истории

---

## 9. Будущие улучшения

1. **Автопродление услуг**: Реализация автоматического продления услуг с `autoRenew = true`
2. **Уведомления**: Уведомления о приближающихся датах окончания услуг
3. **Аналитика**: Расширенные аналитические отчеты и графики
4. **Экспорт**: Экспорт отчетов в Excel и PDF
5. **История изменений**: Аудит-лог всех изменений в системе
6. **Мультивалютность**: Поддержка нескольких валют
7. **Интеграции**: Интеграция с внешними системами учета

---

**Дата создания документа**: 2026-01-21  
**Версия системы**: 1.0.0

name: Deploy to VPS

on:
  push:
    branches:
      - main

# –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –¥–µ–ø–ª–æ–∏
concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE_CONTENT }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: ENV_FILE_CONTENT
          script: |
            cd /var/www/agency-finance
            if [ -n "$ENV_FILE_CONTENT" ]; then
              echo "$ENV_FILE_CONTENT" | base64 -d > .env
              chmod 600 .env
              echo "‚úÖ .env –æ–±–Ω–æ–≤–ª—ë–Ω –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞ ENV_FILE_CONTENT"
            else
              echo "‚ö†Ô∏è –°–µ–∫—Ä–µ—Ç ENV_FILE_CONTENT –Ω–µ –∑–∞–¥–∞–Ω ‚Äî .env –Ω–µ —Ç—Ä–æ–≥–∞–µ–º"
            fi
            git pull origin main
            echo "üîÑ Installing dependencies..."
            npm ci || npm install
            echo "üîÑ Generating Prisma Client..."
            npm run db:generate
            echo "üîÑ Applying DB schema changes..."
            npx prisma db push --skip-generate || echo "‚ö†Ô∏è DB push failed, continuing..."
            echo "üîÑ Applying DB migration (Expense.legalEntityId) if needed..."
            npx prisma db execute --file prisma/add-expense-legal-entity.sql || true
            echo "üîÑ Applying DB migration (LegalEntity fullName, contactInfo) if needed..."
            npx prisma db execute --file prisma/add-legal-entity-fullname-contact.sql || true
            echo "üîÑ Applying DB migration (User extra fields) if needed..."
            npx prisma db execute --file prisma/add-user-fields.sql || true
            echo "üîÑ Applying DB migration (Contracts & Closeout tables) if needed..."
            npx prisma db execute --file prisma/add-contracts-closeout-tables.sql || true
            echo "üîÑ Applying DB migration (Client requisites columns) if needed..."
            npx prisma db execute --file prisma/add-client-requisites-columns.sql || true
            echo "üîÑ Applying DB migration (Niche table) if needed..."
            npx prisma db execute --file prisma/create-niche-table.sql || true
            echo "üîÑ Applying DB migration (Site.nicheId) if needed..."
            npx prisma db execute --file prisma/add-niche-id-to-site.sql || true
            echo "üîÑ Applying DB migration (Site.niche string column) if needed..."
            npx prisma db execute --file prisma/ensure-site-has-niche-column.sql || true
            echo "üîÑ Applying DB migration (Contacts & ClientContact tables) if needed..."
            npx prisma db execute --file prisma/add-contacts-tables.sql || true
            echo "üîÑ Applying DB migration (Agents table & Client.agentId) if needed..."
            npx prisma db execute --file prisma/add-agents-table.sql || true
            echo "üîÑ Applying DB migration (WorkPeriod, Invoice, Payment, period reports) if needed..."
            npx prisma db execute --file prisma/add-work-periods-invoices-payments.sql || true
            echo "üîÑ Applying DB migration (Income.workPeriodId) if needed..."
            npx prisma db execute --file prisma/add-income-work-period-id.sql || true
            echo "üîÑ Applying DB migration (Service.prepaymentType) if needed..."
            npx prisma db execute --file prisma/add-service-prepayment-type.sql || true
            echo "üîÑ Running safe deploy script..."
            if bash scripts/safe-deploy.sh; then
              echo "‚úÖ Safe deploy completed successfully"
            else
              echo "‚ùå Safe deploy failed, but continuing with standard deploy..."
              echo "üîÑ Falling back to standard deploy process..."
              pm2 stop agency-finance 2>/dev/null || true
              sleep 2
              rm -rf .next
              npm run build || {
                echo "‚ùå Build failed in fallback mode"
                exit 1
              }
              pm2 restart agency-finance --update-env || pm2 start npm --name agency-finance -- start
              sleep 10
              pm2 status
            fi
            echo "‚úÖ Application restarted"
            sleep 15
            echo "üìã PM2 Status:"
            pm2 status
            echo ""
            echo "üìã Checking application logs (last 30 lines):"
            pm2 logs agency-finance --lines 30 --nostream || echo "‚ö†Ô∏è Could not get logs"
            echo ""
            echo "üìã Checking for errors:"
            pm2 logs agency-finance --err --lines 20 --nostream || echo "‚ö†Ô∏è No errors found"
            echo ""
            echo "üìã Testing application health:"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>&1 || echo "000")
            echo "HTTP Status: $HTTP_CODE"
            # 200, 302, 307, 401, 404 - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã –æ—Ç–≤–µ—Ç–∞
            if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "302" ] && [ "$HTTP_CODE" != "307" ] && [ "$HTTP_CODE" != "401" ] && [ "$HTTP_CODE" != "404" ]; then
              echo "‚ö†Ô∏è Application not responding (HTTP $HTTP_CODE), attempting quick fix..."
              echo "üîÑ Stopping all processes..."
              pm2 stop agency-finance 2>/dev/null || true
              pm2 delete agency-finance 2>/dev/null || true
              pkill -f "next-server" 2>/dev/null || true
              sleep 3
              echo "üîÑ Starting application..."
              pm2 start npm --name agency-finance -- start || pm2 restart agency-finance --update-env
              sleep 10
              echo "üìã Final health check:"
              HTTP_CODE2=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>&1 || echo "000")
              echo "HTTP Status after recovery: $HTTP_CODE2"
              if [ "$HTTP_CODE2" != "200" ] && [ "$HTTP_CODE2" != "302" ] && [ "$HTTP_CODE2" != "307" ] && [ "$HTTP_CODE2" != "401" ] && [ "$HTTP_CODE2" != "404" ]; then
                echo "‚ö†Ô∏è Application still not responding. Check logs: pm2 logs agency-finance --lines 100"
              fi
            fi

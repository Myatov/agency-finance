name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /var/www/agency-finance
            git pull origin main
            echo "ðŸ”„ Installing dependencies..."
            npm ci || npm install
            echo "ðŸ”„ Generating Prisma Client..."
            npm run db:generate
            echo "ðŸ”„ Applying DB schema changes..."
            npx prisma db push --skip-generate || echo "âš ï¸ DB push failed, continuing..."
            echo "ðŸ”„ Applying DB migration (Expense.legalEntityId) if needed..."
            npx prisma db execute --file prisma/add-expense-legal-entity.sql || true
            echo "ðŸ”„ Applying DB migration (User extra fields) if needed..."
            npx prisma db execute --file prisma/add-user-fields.sql || true
            echo "ðŸ”„ Applying DB migration (Contracts & Closeout tables) if needed..."
            npx prisma db execute --file prisma/add-contracts-closeout-tables.sql || true
            echo "ðŸ”„ Applying DB migration (Client requisites columns) if needed..."
            npx prisma db execute --file prisma/add-client-requisites-columns.sql || true
            echo "ðŸ”„ Applying DB migration (Niche table) if needed..."
            npx prisma db execute --file prisma/create-niche-table.sql || true
            echo "ðŸ”„ Stopping old processes..."
            pm2 stop agency-finance 2>/dev/null || true
            pkill -f "next-server" 2>/dev/null || true
            sleep 2
            echo "ðŸ”„ Cleaning old build..."
            rm -rf .next
            echo "ðŸ”„ Building application..."
            npm run build
            echo "âœ… Build completed"
            echo "ðŸ”„ Restarting application..."
            pm2 restart agency-finance --update-env || pm2 start npm --name agency-finance -- start
            echo "âœ… Application restarted"
            sleep 15
            echo "ðŸ“‹ PM2 Status:"
            pm2 status
            echo ""
            echo "ðŸ“‹ Checking application logs (last 30 lines):"
            pm2 logs agency-finance --lines 30 --nostream || echo "âš ï¸ Could not get logs"
            echo ""
            echo "ðŸ“‹ Checking for errors:"
            pm2 logs agency-finance --err --lines 20 --nostream || echo "âš ï¸ No errors found"
            echo ""
            echo "ðŸ“‹ Testing application health:"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>&1 || echo "000")
            echo "HTTP Status: $HTTP_CODE"
            if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "302" ] && [ "$HTTP_CODE" != "401" ] && [ "$HTTP_CODE" != "404" ]; then
              echo "âš ï¸ Application not responding, running recovery script..."
              bash scripts/fix-502-complete.sh || echo "âš ï¸ Recovery script failed"
              echo ""
              echo "ðŸ“‹ Final health check:"
              sleep 5
              HTTP_CODE2=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>&1 || echo "000")
              echo "HTTP Status after recovery: $HTTP_CODE2"
            fi

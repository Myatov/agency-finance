#!/bin/bash
set -e

echo "=========================================="
echo "üõ°Ô∏è –ë–ï–ó–û–ü–ê–°–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï (–ë–ï–ó –ü–û–¢–ï–†–ò –î–ê–ù–ù–´–•)"
echo "=========================================="
echo ""

cd /var/www/agency-finance || exit 1

echo "1Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pm2 delete agency-finance 2>/dev/null || true
pkill -f "next build" 2>/dev/null || true
sleep 3
echo "‚úì –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
echo ""

echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.bin/prisma" ]; then
    echo "üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    npm ci
fi
echo "‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞ –º–µ—Å—Ç–µ"
echo ""

echo "3Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client (–ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏—è –ë–î)..."
npm run db:generate
echo "‚úì Prisma Client –≥–æ—Ç–æ–≤"
echo ""

echo "4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–±–æ—Ä–∫–∏..."
if [ -d ".next" ] && [ -f ".next/BUILD_ID" ]; then
    echo "‚úì –°–±–æ—Ä–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë"
    BUILD_EXISTS=true
else
    echo "‚ö†Ô∏è –°–±–æ—Ä–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞"
    BUILD_EXISTS=false
fi
echo ""

if [ "$BUILD_EXISTS" = "false" ]; then
    echo "5Ô∏è‚É£ –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    rm -rf .next
    npm run build
    echo "‚úì –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
else
    echo "5Ô∏è‚É£ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é)"
fi
echo ""

echo "6Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 start npm --name agency-finance -- start
echo "‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"
echo ""

echo "7Ô∏è‚É£ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (20 —Å–µ–∫—É–Ω–¥)..."
sleep 20

echo ""
echo "8Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
pm2 status
echo ""

echo "9Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫)..."
pm2 logs agency-finance --lines 50 --nostream 2>&1 | tail -50
echo ""

echo "üîü –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")
if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "401" ]; then
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç! (HTTP $HTTP_CODE)"
else
    echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (HTTP $HTTP_CODE)"
    echo ""
    echo "üìã –û–®–ò–ë–ö–ò –í –õ–û–ì–ê–•:"
    pm2 logs agency-finance --err --lines 30 --nostream 2>&1 | tail -30
fi
echo ""

echo "=========================================="
echo "‚úÖ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û"
echo "=========================================="

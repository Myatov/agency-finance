#!/bin/bash
set -e

echo "=========================================="
echo "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê 502 BAD GATEWAY"
echo "=========================================="
echo ""

cd /var/www/agency-finance || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞"; exit 1; }

echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PM2..."
echo "----------------------------"
pm2 status
echo ""

echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js..."
echo "----------------------------"
ps aux | grep -E "node|next" | grep -v grep || echo "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å—ã Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
echo ""

echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 3000..."
echo "----------------------------"
netstat -tlnp | grep :3000 || ss -tlnp | grep :3000 || echo "‚ö†Ô∏è –ü–æ—Ä—Ç 3000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
echo ""

echo "4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
echo "----------------------------"
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.bin/prisma" ]; then
    echo "‚ùå –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã!"
    echo "üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    npm ci || npm install
else
    echo "‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
fi
echo ""

echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Prisma Client..."
echo "----------------------------"
if [ ! -d "node_modules/@prisma/client" ]; then
    echo "‚ùå Prisma Client –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Prisma Client..."
    npm run db:generate
else
    echo "‚úì Prisma Client –Ω–∞–π–¥–µ–Ω"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–µ–ª–∏ Niche
    if grep -q "model Niche" prisma/schema.prisma; then
        if ! grep -q "Niche" node_modules/@prisma/client/index.d.ts 2>/dev/null; then
            echo "‚ö†Ô∏è –ú–æ–¥–µ–ª—å Niche –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Prisma Client, –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é..."
            npm run db:generate
        else
            echo "‚úì –ú–æ–¥–µ–ª—å Niche –Ω–∞–π–¥–µ–Ω–∞ –≤ Prisma Client"
        fi
    fi
fi
echo ""

echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã –ë–î..."
echo "----------------------------"
echo "üîÑ –ü—Ä–∏–º–µ–Ω—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã..."
echo "‚ö†Ô∏è  –ï—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ–π –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è primary keys"
npx prisma db push --skip-generate --accept-data-loss 2>&1 | head -30 || echo "‚ö†Ô∏è DB push –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
echo ""

echo "7Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ PM2 (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫)..."
echo "----------------------------"
pm2 logs agency-finance --lines 50 --nostream 2>&1 | tail -50 || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
echo ""

echo "8Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö..."
echo "----------------------------"
pm2 logs agency-finance --err --lines 20 --nostream 2>&1 | tail -20 || echo "‚ö†Ô∏è –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –∏–ª–∏ –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
echo ""

echo "9Ô∏è‚É£ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
echo "----------------------------"
pm2 restart agency-finance --update-env 2>&1 || {
    echo "‚ö†Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è, –ø—ã—Ç–∞—é—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ..."
    pm2 delete agency-finance 2>/dev/null || true
    pm2 start npm --name agency-finance -- start
}
echo ""

echo "üîü –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (10 —Å–µ–∫—É–Ω–¥)..."
echo "----------------------------"
sleep 10

echo ""
echo "1Ô∏è‚É£1Ô∏è‚É£ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
echo "----------------------------"
pm2 status
echo ""

echo "1Ô∏è‚É£2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
echo "----------------------------"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:3000 || echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:3000"
echo ""

echo "1Ô∏è‚É£3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
echo "----------------------------"
if [ -f "/etc/nginx/sites-available/agency-finance" ]; then
    echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx:"
    cat /etc/nginx/sites-available/agency-finance | grep -A 5 "proxy_pass" || echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ proxy_pass –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"
elif [ -f "/etc/nginx/conf.d/agency-finance.conf" ]; then
    echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx:"
    cat /etc/nginx/conf.d/agency-finance.conf | grep -A 5 "proxy_pass" || echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ proxy_pass –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"
else
    echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö"
fi
echo ""

echo "=========================================="
echo "‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê"
echo "=========================================="
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫"
echo "2. –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs agency-finance --lines 100"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: sudo systemctl reload nginx"
echo "4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DATABASE_URL –≤ .env –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"

#!/bin/bash
set -e

echo "=========================================="
echo "üîç –ü–†–û–í–ï–†–ö–ê –õ–û–ì–û–í –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï"
echo "=========================================="
echo ""

cd /var/www/agency-finance || exit 1

echo "1Ô∏è‚É£ –°—Ç–∞—Ç—É—Å PM2..."
pm2 status
echo ""

echo "2Ô∏è‚É£ –õ–û–ì–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫) - –í–ê–ñ–ù–û!"
echo "=========================================="
pm2 logs agency-finance --lines 100 --nostream 2>&1 | tail -100
echo ""

echo "3Ô∏è‚É£ –û–®–ò–ë–ö–ò (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫) - –í–ê–ñ–ù–û!"
echo "=========================================="
pm2 logs agency-finance --err --lines 50 --nostream 2>&1 | tail -50
echo ""

echo "4Ô∏è‚É£ –ü–æ–ø—ã—Ç–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
echo "=========================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å Prisma
ERRORS=$(pm2 logs agency-finance --err --lines 100 --nostream 2>&1 | tail -100)

if echo "$ERRORS" | grep -q "Prisma\|prisma\|Niche\|CostCategory"; then
    echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ Prisma, –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é Client..."
    npm run db:generate
    pm2 restart agency-finance --update-env
    sleep 10
    echo "‚úì –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
fi

echo ""
echo "5Ô∏è‚É£ –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å..."
pm2 status
echo ""

echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞..."
netstat -tlnp | grep :3000 || ss -tlnp | grep :3000 || echo "‚ö†Ô∏è –ü–æ—Ä—Ç 3000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
echo ""

echo "=========================================="
echo "‚úÖ –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê"
echo "=========================================="
echo ""
echo "üìã –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–∏—à–ª–∏—Ç–µ –≤—ã–≤–æ–¥ –ª–æ–≥–æ–≤ –≤—ã—à–µ"

# Финансы агентства - MVP

Веб-приложение для управления финансами агентства онлайн-продвижения и разработки сайтов.

## Технологии

- **Frontend**: Next.js 14 (App Router) + TypeScript + Tailwind CSS
- **Backend**: Next.js API Routes (Route Handlers)
- **Database**: PostgreSQL + Prisma ORM
- **Auth**: Парольная авторизация с httpOnly cookie-сессиями
- **Password hashing**: bcryptjs

## Установка и запуск

1. Установите зависимости:
```bash
npm install
```

2. Настройте базу данных:
```bash
# Создайте файл .env с DATABASE_URL
echo 'DATABASE_URL="postgresql://user:password@localhost:5432/agency_finance?schema=public"' > .env

# Сгенерируйте Prisma Client
npm run db:generate

# Примените миграции
npm run db:push

# Заполните базу начальными данными
npm run db:seed
```

**Обновление БД на сервере** (если в таблице `CostItem` уже есть данные со старым полем `category`):  
сначала выполните миграцию, затем примените схему и при необходимости сид:

```bash
# На сервере (или с DATABASE_URL сервера):
# 1. Применить миграцию SQL (или использовать скрипт)
psql "$DATABASE_URL" -f prisma/migrate-to-cost-categories.sql
# ИЛИ использовать Node скрипт:
npm run db:migrate-server

# 2. ОБЯЗАТЕЛЬНО перегенерировать Prisma Client после миграции!
npm run db:generate

# 3. Перезапустить приложение, чтобы подхватить новый Prisma Client
# (если используется PM2: pm2 restart app)
# (если используется systemd: systemctl restart your-app)

# 4. При необходимости обновить справочники
npm run db:seed
```

**Если возникает ошибка "Database schema error: CostCategory model not available":**

Это означает, что Prisma Client на сервере не был перегенерирован после миграции схемы БД.

**БЫСТРОЕ РЕШЕНИЕ (выполните на сервере):**

```bash
cd /path/to/your/app

# Вариант 1: Использовать готовый скрипт
bash scripts/fix-prisma-client.sh

# Вариант 2: Выполнить вручную
npm run db:generate
pm2 restart app  # или systemctl restart your-app
```

**Подробная инструкция:**

1. **Подключитесь к серверу по SSH**

2. **Перейдите в директорию проекта:**
```bash
cd /path/to/your/app
```

3. **Перегенерируйте Prisma Client:**
```bash
npm run db:generate
```

4. **Перезапустите приложение:**
```bash
# Если используется PM2:
pm2 restart app

# Если используется systemd:
systemctl restart your-app

# Если используется другой менеджер процессов, перезапустите его
```

5. **Проверьте, что ошибка исчезла:**
   - Откройте страницу "Статьи расходов" в браузере
   - Или проверьте `/api/debug-cost-items` - там будет диагностика

**Автоматическая проверка при старте (опционально):**

Можно добавить проверку Prisma Client перед стартом приложения:
```json
// В package.json добавить:
"prestart": "tsx scripts/ensure-prisma-client.ts"
```

Или запустить вручную перед стартом:
```bash
npx tsx scripts/ensure-prisma-client.ts
```

3. Запустите dev сервер:
```bash
npm run dev
```

4. Откройте http://localhost:3000

## Пользователи по умолчанию

### Управленцы
- **Мятов Михаил** (OWNER) - пароль: `1407`
- **Левинова Маргарита** (CEO) - пароль: `mng`

### Системные роли
- **Старший Аккаунт** (HEAD_ACCOUNTING) - пароль: `Acount`
- **Финансист** (FINANCE) - пароль: `finA`

### Аккаунт-менеджеры
- **Ангелина** - пароль: `ang`
- **Тимур** - пароль: `t-mur`
- **Никита** - пароль: `nkit`
- **Света** - пароль: `sva`

Полный список пользователей см. в `prisma/seed.ts`

## Принятые допущения

### 1. Безопасность паролей
**Проблема**: ТЗ требует "пароли могут видеть CEO и владелец", но это конфликтует с безопасностью (пароли хранятся как bcrypt hash).

**Решение**: 
- OWNER и CEO могут **сбрасывать и задавать новый пароль** любому пользователю
- Просмотр/копирование текущего пароля невозможен (хранится только hash)
- Это стандартная практика безопасности

### 2. Конфликты паролей
**Проблема**: В ТЗ встречаются дубли паролей (например, "Ангелина" с паролями "ang" и "angl").

**Решение**:
- Один человек = один пароль
- Выбрано основное значение из списка аккаунт-менеджеров: "ang"
- Конфликтные значения зафиксированы в seed скрипте

### 3. Хранение сумм
**Решение**: Суммы хранятся в копейках как `BigInt` в БД, преобразуются в рубли при отображении.

### 4. Системный клиент "Без клиентов"
- Создается автоматически при seed
- Нельзя удалить
- При удалении любого другого клиента все его проекты переводятся в "Без клиентов"

### 5. Права доступа к отчетам
**Решение для MVP**:
- OWNER/CEO/HEAD_ACCOUNTING/FINANCE видят все отчеты
- ACCOUNT_MANAGER видит отчеты только по своим проектам
- Остальные сотрудники - read-only по общим агрегатам или скрыто (для MVP скрыто)

### 6. Продавцы и доходы
- Продавец определяется как сотрудник, назначенный `sellerEmployeeId` у клиента
- Продавец может добавлять доходы к проектам своих клиентов
- Проверка происходит при создании дохода

### 7. Удаление проектов
- Запрещено удаление проекта, если есть связанные доходы или расходы
- При попытке удаления показывается ошибка

### 8. Редактирование расходов
- Пользователь может редактировать только свои расходы
- OWNER и CEO могут редактировать любые расходы
- При редактировании обновляются `updatedAt` и `updatedByUserId`

### 9. Реквизиты клиентов
- Если `payTo` = `IP_MYATOV_VTB` или `IP_MYATOV_SBERBANK`, все реквизитные поля обязательны
- Для других способов оплаты реквизиты не требуются

### 10. Продукты
- Дубликат "Яндекс Карты" в списке продуктов оставлен один раз
- Факт дубля зафиксирован в seed скрипте

## Структура проекта

```
/app
  /api          - API routes
  /projects     - Раздел проектов
  /clients      - Раздел клиентов
  /incomes      - Раздел доходов
  /expenses     - Раздел расходов
  /employees    - Раздел сотрудников
  /products     - Раздел продуктов
  /reports      - Раздел отчетов
/components     - React компоненты
/lib            - Утилиты и helpers
/prisma         - Prisma schema и seed
```

## Роли и доступы

- **OWNER** - полный доступ ко всему
- **CEO** - полный доступ ко всему
- **HEAD_ACCOUNTING** - доступ ко всем проектам
- **FINANCE** - доступ к финансовым данным
- **ACCOUNT_MANAGER** - доступ к своим проектам, добавление доходов
- **DEPT_HEAD** - управление сотрудниками своего отдела
- **EMPLOYEE** - базовый доступ (read-only для большинства разделов)

## Разделы приложения

1. **Проекты** - управление проектами, фильтры, последние платежи
2. **Клиенты** - управление клиентами, реквизиты
3. **Доходы** - добавление и просмотр доходов
4. **Расходы** - быстрая форма добавления, фильтры, справочник затрат
5. **Сотрудники** - управление сотрудниками по отделам, смена паролей
6. **Продукты** - справочник продуктов
7. **Отчеты** - агрегированные отчеты по доходам/расходам

## Разработка

### Команды

```bash
npm run dev          # Запуск dev сервера
npm run build        # Сборка для production
npm run start        # Запуск production сервера
npm run db:generate  # Генерация Prisma Client
npm run db:push      # Применение изменений схемы
npm run db:migrate   # Создание миграции
npm run db:seed      # Заполнение базы начальными данными
```

### Добавление новых функций

1. Обновите Prisma schema при необходимости
2. Создайте API routes в `/app/api`
3. Создайте страницы и компоненты
4. Обновите права доступа в `/lib/permissions.ts`
5. Протестируйте end-to-end

## Примечания

- Все суммы хранятся в копейках (BigInt)
- Даты в формате ISO, отображаются в формате ru-RU
- Пароли хешируются с помощью bcrypt (10 rounds)
- Сессии хранятся в httpOnly cookies (7 дней)

## Реализованные разделы

✅ **Все основные разделы реализованы:**

1. ✅ **Проекты** - полный CRUD, фильтры, отображение последних платежей
2. ✅ **Клиенты** - полный CRUD, реквизиты, логика "Без клиентов"
3. ✅ **Доходы** - CRUD с ограничениями по проектам, фильтры
4. ✅ **Расходы** - быстрая форма добавления, справочник затрат, фильтры
5. ✅ **Сотрудники** - полный CRUD, управление по отделам, смена паролей
6. ✅ **Продукты** - CRUD (только OWNER/CEO), drag-n-drop для изменения порядка
7. ✅ **Отчеты** - агрегации по доходам/расходам/сотрудникам, CSV экспорт

## Возможные улучшения

- [ ] Улучшение фильтров в разделах (добавление больше опций)
- [ ] Валидация форм на клиенте (более детальная)
- [ ] Улучшенная обработка ошибок и loading states
- [ ] Мобильная адаптация UI
- [ ] Пагинация для больших списков
- [ ] Поиск по всем разделам

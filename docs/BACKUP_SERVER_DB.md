# Бэкап базы данных сервера

Инструкция: как сделать дамп PostgreSQL с продакшен-сервера.

---

## Краткая инструкция: бэкап БД через SSH и скачивание в папку Downloads

**Цель:** сделать дамп базы на сервере и скачать файл к себе в папку **Downloads** на локальный компьютер.

### Шаг 1. Подключиться к серверу по SSH

На своём компьютере (в терминале):

```bash
ssh ПОЛЬЗОВАТЕЛЬ@IP_ИЛИ_ДОМЕН_СЕРВЕРА
```

Подставь свой логин и адрес сервера (например, `root@62.217.176.108` или `deploy@agency-finance.example.com`).

---

### Шаг 2. На сервере: узнать данные БД и создать дамп

После входа на сервер выполни:

```bash
cd /var/www/agency-finance
grep DATABASE_URL .env
```

Из строки `DATABASE_URL="postgresql://ЛОГИН:ПАРОЛЬ@ХОСТ:ПОРТ/ИМЯ_БД?schema=public"` запомни:
- **ЛОГИН** — пользователь БД (между `://` и `:`)
- **ПАРОЛЬ** — между первым `:` и `@`
- **ИМЯ_БД** — имя базы (между последним `/` и `?`, часто `agency_finance`)

Создать дамп (подставь свои ЛОГИН, ПАРОЛЬ и ИМЯ_БД):

```bash
export PGPASSWORD='ПАРОЛЬ'
pg_dump -h localhost -U ЛОГИН -d ИМЯ_БД -F c -f /tmp/agency_finance_$(date +%Y%m%d_%H%M%S).dump
unset PGPASSWORD
```

Файл появится в `/tmp/`, например: `agency_finance_20260208_180000.dump`. Запомни точное имя (можно вывести список: `ls -la /tmp/agency_finance_*.dump`).

Выйти с сервера:

```bash
exit
```

---

### Шаг 3. На своём компьютере: скачать дамп в папку Downloads

В том же терминале (уже на локальном компьютере, не по SSH):

```bash
scp ПОЛЬЗОВАТЕЛЬ@IP_ИЛИ_ДОМЕН_СЕРВЕРА:/tmp/agency_finance_YYYYMMDD_HHMMSS.dump ~/Downloads/
```

Подставь:
- **ПОЛЬЗОВАТЕЛЬ** и **IP_ИЛИ_ДОМЕН_СЕРВЕРА** — те же, что для SSH;
- **agency_finance_YYYYMMDD_HHMMSS.dump** — точное имя файла из шага 2.

Пример:

```bash
scp root@62.217.176.108:/tmp/agency_finance_20260208_180000.dump ~/Downloads/
```

После выполнения файл дампа будет в папке **Загрузки (Downloads)**.

(При необходимости потом можно удалить дамп с сервера по SSH: `rm /tmp/agency_finance_*.dump`.)

---

## Где взять логин, пароль и данные для подключения

Данные для подключения к БД **не хранятся в репозитории** — они только на сервере (или у того, кто настраивал деплой).

### Вариант 1: С сервера (рекомендуется)

1. Подключись к VPS по SSH:
   ```bash
   ssh пользователь@IP_или_домен_сервера
   ```
   (логин и IP/домен — те, что ты используешь для доступа к серверу.)

2. Перейди в папку проекта и посмотри переменную `DATABASE_URL`:
   ```bash
   cd /var/www/agency-finance
   grep DATABASE_URL .env
   ```
   Или выведи весь `.env` (осторожно, не свети его в чаты):
   ```bash
   cat .env | grep DATABASE_URL
   ```

3. Строка выглядит так:
   ```text
   DATABASE_URL="postgresql://ЛОГИН:ПАРОЛЬ@ХОСТ:ПОРТ/ИМЯ_БД?schema=public"
   ```
   Из неё:
   - **Логин (user)** — часть между `://` и `:`
   - **Пароль** — между первым `:` и `@`
   - **Хост** — после `@` до `:`
   - **Порт** — после хоста до `/`
   - **Имя БД** — между последним `/` и `?` (или до конца строки)

Пример:  
`postgresql://agency_finance:SecretPass123@62.217.176.108:5432/agency_finance?schema=public`  
→ пользователь `agency_finance`, пароль `SecretPass123`, хост `62.217.176.108`, порт `5432`, БД `agency_finance`.

---

### Вариант 2: Из панели хостинга / VPS

Если БД создавалась через панель (например, Timeweb, Reg.ru, Selectel и т.п.):

- Зайди в панель → раздел «Базы данных» / «PostgreSQL».
- Там будут: хост, порт, имя БД, пользователь, пароль (часто «показать пароль» или «сбросить»).

Эти же данные должны быть прописаны в `DATABASE_URL` в `.env` на сервере.

---

## Как сделать бэкап

### Способ A: Прямо на сервере (через SSH)

1. Подключись по SSH к серверу.
2. Перейди в каталог проекта и подставь свои значения:
   ```bash
   cd /var/www/agency-finance
   source .env 2>/dev/null || true
   # Или вручную задай переменную (подставь свои данные):
   # export PGPASSWORD='твой_пароль_БД'
   pg_dump -h localhost -U agency_finance -d agency_finance -F c -f backup_$(date +%Y%m%d_%H%M%S).dump
   ```
   Если БД на этом же сервере, хост обычно `localhost`. Имя пользователя и БД смотри в `DATABASE_URL` из `.env`.

3. Пароль запросит интерактивно, либо задай перед командой:
   ```bash
   export PGPASSWORD='пароль_из_DATABASE_URL'
   pg_dump -h localhost -U ИМЯ_ПОЛЬЗОВАТЕЛЯ -d ИМЯ_БД -F c -f backup_$(date +%Y%m%d_%H%M%S).dump
   unset PGPASSWORD
   ```

4. Файл `backup_YYYYMMDD_HHMMSS.dump` появится в `/var/www/agency-finance/`.  
   Скачай его к себе (например через SCP):
   ```bash
   # Выполнить на своём компьютере (не на сервере):
   scp пользователь@IP_сервера:/var/www/agency-finance/backup_*.dump ./
   ```

---

### Способ B: Своего компьютера (если БД доступна снаружи)

Если в `DATABASE_URL` хост — не `localhost`, а внешний IP/домен, и порт 5432 открыт:

1. Узнай из `.env` на сервере: хост, порт, пользователь, пароль, имя БД (см. выше).
2. На своём компьютере установи клиент PostgreSQL (если ещё нет):
   - **macOS:** `brew install libpq` или `brew install postgresql`
   - **Windows:** установщик с [postgresql.org](https://www.postgresql.org/download/windows/)
3. Выполни (подставь свои данные):
   ```bash
   export PGPASSWORD='пароль'
   pg_dump -h ХОСТ -p ПОРТ -U ИМЯ_ПОЛЬЗОВАТЕЛЯ -d ИМЯ_БД -F c -f backup_$(date +%Y%m%d_%H%M%S).dump
   unset PGPASSWORD
   ```
   Или с паролем в одной строке (менее безопасно):
   ```bash
   PGPASSWORD='пароль' pg_dump -h ХОСТ -p ПОРТ -U ИМЯ_ПОЛЬЗОВАТЕЛЯ -d ИМЯ_БД -F c -f backup_сервера.dump
   ```

---

### Способ C: Через готовый скрипт на сервере

В проекте есть полный бэкап (проект + опционально БД):

```bash
# На сервере в папке проекта:
cd /var/www/agency-finance
bash scripts/backup-full.sh
```

Скрипт создаёт папку `backups/agency-finance_ДАТА_ВРЕМЯ` с:
- `project.tar.gz` — файлы проекта;
- `.env.backup` — копия `.env`;
- `database.dump` — дамп БД (если установлен `pg_dump` и в `.env` есть `DATABASE_URL`).

На сервере должен быть установлен `pg_dump` (пакет `postgresql-client` или `postgresql`).  
Скачать готовый бэкап к себе можно так (выполнить на своём компьютере):

```bash
scp -r пользователь@IP_сервера:/var/www/agency-finance/backups/agency-finance_* ./
```

---

## Кратко

| Что нужно | Где взять |
|----------|-----------|
| Логин (user) | Из `DATABASE_URL` в `.env` на сервере (часть между `://` и `:`) |
| Пароль | Из `DATABASE_URL` в `.env` (между `:` и `@`) |
| Хост | В `.env`: часть после `@` до `:` (часто `localhost` или IP) |
| Порт | Обычно `5432` |
| Имя БД | В `.env`: между последним `/` и `?` (часто `agency_finance`) |

**Минимальная команда бэкапа на сервере** (подставь логин, пароль и имя БД из своего `.env`):

```bash
cd /var/www/agency-finance
PGPASSWORD='ПАРОЛЬ' pg_dump -h localhost -U ЛОГИН -d ИМЯ_БД -F c -f backup_$(date +%Y%m%d).dump
```

Файл дампа потом скачай к себе через `scp` и храни в безопасном месте.

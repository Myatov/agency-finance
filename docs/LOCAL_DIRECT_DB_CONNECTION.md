# Вариант 2: Прямое подключение локального проекта к БД на VPS

Локальный проект подключается к PostgreSQL на VPS по IP и порту 5432. Все шаги по порядку.

---

## Что понадобится

- Доступ по SSH к VPS
- IP или домен VPS
- Пароль пользователя БД `agency_finance` (тот, что задавали при настройке сервера)
- Твой внешний IP — только если используешь **вариант с привязкой к IP** (см. ниже)

---

## Подключение без указания своего IP

Подключаться к БД можно **с любого места** (любой IP), без привязки к твоему адресу. Так удобно при динамическом IP или при работе с разных компьютеров.

**Минус:** порт 5432 будет доступен из интернета для всех. Кто угодно сможет пытаться подобрать пароль. Поэтому обязательно:

- Задай **сложный пароль** для пользователя `agency_finance` (длина 16+ символов, буквы, цифры, символы).
- Не используй этот способ долго на продакшене; лучше ограничить доступ по IP или использовать SSH-туннель (вариант 1 в [LOCAL_TO_REMOTE_DB.md](LOCAL_TO_REMOTE_DB.md)).

Ниже в шагах 1, 3.2 и 4 указаны **два варианта**: с указанием своего IP (безопаснее) и без (подключение с любого IP). Выбери один.

---

## Шаг 1: Узнать свой внешний IP (только для варианта с привязкой к IP)

На своём компьютере в терминале или в браузере:

```bash
curl -s ifconfig.me
```

Или открой в браузере: https://ifconfig.me

Запиши этот IP — он понадобится для фаервола и `pg_hba.conf`. Если у тебя динамический IP (меняется при переподключении к интернету), после смены IP придётся обновить правила на VPS.

---

## Шаг 2: На VPS — версия PostgreSQL и путь к конфигам

Подключись к VPS по SSH:

```bash
ssh пользователь@IP_VPS
```

Узнай версию PostgreSQL (например, 15 или 16):

```bash
sudo -u postgres psql -c "SHOW server_version;"
```

Или посмотри, какая папка есть:

```bash
ls /etc/postgresql/
```

Будет что-то вроде `15` или `16`. Дальше в инструкции используется `15` — замени на свою версию, если нужно. Путь к конфигам: `/etc/postgresql/15/main/`.

---

## Шаг 3: Разрешить PostgreSQL принимать внешние подключения

### 3.1. Файл `postgresql.conf`

```bash
sudo nano /etc/postgresql/15/main/postgresql.conf
```

Найди строку (поиск в nano: `Ctrl+W`, ввести `listen_addresses`):

```
#listen_addresses = 'localhost'
```

Замени на (раскомментируй и поставь `*`):

```
listen_addresses = '*'
```

Сохрани: `Ctrl+O`, Enter, выход: `Ctrl+X`.

### 3.2. Файл `pg_hba.conf`

```bash
sudo nano /etc/postgresql/15/main/pg_hba.conf
```

В **конец файла** добавь **одну** из двух строк:

**Вариант А — только с твоего IP (безопаснее):** подставь свой IP вместо `ТВОЙ_IP`:

```
# Доступ к БД agency_finance только с твоего компьютера
host    agency_finance    agency_finance    ТВОЙ_IP/32    scram-sha-256
```

Пример: `host    agency_finance    agency_finance    85.123.45.67/32    scram-sha-256`

**Вариант Б — с любого IP (без привязки к твоему адресу):**

```
# Доступ к БД agency_finance с любого IP (обязателен сложный пароль!)
host    agency_finance    agency_finance    0.0.0.0/0    scram-sha-256
```

Сохрани и выйди.

### 3.3. Перезапустить PostgreSQL

```bash
sudo systemctl restart postgresql
sudo systemctl status postgresql
```

В статусе должно быть `active (running)`. Выход из просмотра: `q`.

---

## Шаг 4: Открыть порт 5432 в фаерволе

На VPS выполни **один** из вариантов.

**Вариант А — только для твоего IP (безопаснее):** подставь свой IP:

```bash
sudo ufw allow from ТВОЙ_IP to any port 5432 comment "PostgreSQL for local dev"
sudo ufw reload
```

**Вариант Б — с любого IP (подключение без привязки к твоему адресу):**

```bash
sudo ufw allow 5432/tcp comment "PostgreSQL remote"
sudo ufw reload
```

Проверить правила:

```bash
sudo ufw status numbered
```

Если фаервол раньше не включал:

```bash
sudo ufw enable
```

и снова команду `allow` выше.

На этом настройка VPS закончена. Можно отключиться от SSH или оставить терминал открытым.

---

## Шаг 5: Локально — файл `.env`

На своём компьютере открой папку проекта и создай или отредактируй файл `.env` в корне проекта (рядом с `package.json`).

Содержимое (подставь свои значения):

```env
DATABASE_URL="postgresql://agency_finance:ПАРОЛЬ_ОТ_БД@IP_VPS:5432/agency_finance?schema=public"
```

- `agency_finance` — имя пользователя и базы (как при настройке сервера).
- `ПАРОЛЬ_ОТ_БД` — пароль пользователя `agency_finance` (без кавычек; если в пароле есть спецсимволы, можно взять URL в кавычки).
- `IP_VPS` — IP или домен твоего VPS (например `123.45.67.89` или `server.example.com`).

Пример:

```env
DATABASE_URL="postgresql://agency_finance:MySecretPass123@123.45.67.89:5432/agency_finance?schema=public"
```

Сохрани файл.

---

## Шаг 6: Проверка подключения локально

В папке проекта выполни:

```bash
npm run db:generate
npx prisma db pull
```

Если ошибок нет — подключение к БД на VPS работает. `db pull` только считывает схему, данные не трогает. Дальше можно запускать приложение:

```bash
npm run dev
```

Открой в браузере http://localhost:3000 — данные будут с сервера.

---

## Если не подключается

1. **Проверь IP в правилах**  
   Твой внешний IP мог смениться. Узнай заново: `curl ifconfig.me`. Обнови строку в `pg_hba.conf` и правило ufw, затем:
   ```bash
   sudo systemctl restart postgresql
   sudo ufw reload
   ```

2. **Проверь версию PostgreSQL**  
   Путь может быть не 15, а 16: тогда везде используй `/etc/postgresql/16/main/`.

3. **Проверь пароль БД**  
   На VPS:
   ```bash
   sudo -u postgres psql -c "\du"
   ```
   Пользователь `agency_finance` должен быть. Сброс пароля:
   ```bash
   sudo -u postgres psql -c "ALTER USER agency_finance WITH PASSWORD 'новый_пароль';"
   ```
   Обнови пароль в локальном `.env`.

4. **Порт 5432 закрыт провайдером VPS**  
   В панели хостинга (если есть) открой входящий TCP 5432 или проверь, что нет дополнительного фаервола перед сервером.

5. **Тест с VPS**  
   Подключись по SSH и проверь, что Postgres слушает порт:
   ```bash
   sudo ss -tlnp | grep 5432
   ```
   Должно быть `0.0.0.0:5432` или `*:5432`.

---

## Краткий чеклист (вариант 2)

**С привязкой к IP:**
- [ ] Узнал свой внешний IP
- [ ] В `pg_hba.conf`: строка с твоим IP (`ТВОЙ_IP/32`)
- [ ] В ufw: `allow from ТВОЙ_IP to any port 5432`

**Без привязки к IP (подключение с любого места):**
- [ ] В `pg_hba.conf`: строка `0.0.0.0/0`
- [ ] В ufw: `allow 5432/tcp`
- [ ] Пароль БД сложный (16+ символов)

**Общее:**
- [ ] На VPS: в `postgresql.conf` выставлено `listen_addresses = '*'`
- [ ] На VPS: `sudo systemctl restart postgresql`
- [ ] На VPS: `sudo ufw reload`
- [ ] Локально: в `.env` указан `DATABASE_URL` с IP VPS, портом 5432 и паролем
- [ ] Локально: `npm run db:generate` и `npm run dev` — без ошибок подключения

После этого локальный проект связан с БД на сервере по варианту 2.

# Работа с БД на VPS локально

Ты подключил локальный проект к БД на VPS. Как вносить изменения в схему и данные.

---

## Текущая настройка

В `.env` у тебя:
```env
DATABASE_URL="postgresql://agency_finance:пароль@62.217.176.108:5432/agency_finance?schema=public"
```

Это означает, что все команды Prisma будут выполняться на БД на VPS.

---

## Как вносить изменения в схему БД

### 1. Изменить схему

Отредактируй `prisma/schema.prisma` (добавь поля, таблицы, измени типы и т.д.).

### 2. Применить изменения к БД на VPS

**Вариант А — `db push` (быстро, без миграций):**

```bash
npm run db:generate
npx prisma db push
```

Это сразу применит изменения к БД на VPS. Подходит для разработки.

**Вариант Б — миграции (история изменений):**

```bash
npm run db:generate
npx prisma migrate dev --name описание_изменения
```

Создаст файл миграции в `prisma/migrations/` — его нужно закоммитить в Git. На VPS после `git pull` выполни:

```bash
npx prisma migrate deploy
```

---

## Как работать с данными

### Просмотр данных через Prisma Studio

```bash
npx prisma studio
```

Откроется браузер с интерфейсом для просмотра и редактирования данных в БД на VPS.

### Заполнить начальными данными

```bash
npm run db:seed
```

Выполнит скрипт `prisma/seed.ts` — добавит роли, пользователей и т.д.

### SQL-запросы напрямую

```bash
npx prisma db execute --stdin
```

Или через psql (если установлен):

```bash
psql "postgresql://agency_finance:пароль@62.217.176.108:5432/agency_finance"
```

---

## Важно: безопасность

**Текущая настройка** (прямое подключение по IP) означает, что:
- Порт 5432 на VPS открыт в интернет (или для твоего IP).
- Любой, кто знает пароль, может подключиться.

**Рекомендация для разработки:** используй SSH-туннель (безопаснее).

### Переключиться на SSH-туннель

1. В отдельном терминале запусти туннель:
   ```bash
   ssh -L 5433:localhost:5432 пользователь@62.217.176.108 -N
   ```

2. В `.env` измени:
   ```env
   DATABASE_URL="postgresql://agency_finance:пароль@localhost:5433/agency_finance?schema=public"
   ```

3. Перезапусти проект:
   ```bash
   npm run dev
   ```

Так порт 5432 на VPS не будет открыт в интернет, трафик пойдёт через SSH.

---

## Типичные команды

| Задача | Команда |
|--------|---------|
| Изменить схему и применить | `npm run db:generate` → `npx prisma db push` |
| Посмотреть данные | `npx prisma studio` |
| Заполнить начальными данными | `npm run db:seed` |
| Проверить подключение | `npx prisma db pull` |
| Создать миграцию | `npx prisma migrate dev --name название` |

---

## Рабочий процесс

1. **Редактируешь код** (компоненты, API routes, схему Prisma).
2. **Меняешь схему БД** → редактируешь `prisma/schema.prisma`.
3. **Применяешь изменения** → `npm run db:generate` → `npx prisma db push`.
4. **Тестируешь локально** → `npm run dev` (работает с БД на VPS).
5. **Коммитишь изменения** → `git add .` → `git commit` → `git push`.
6. **На VPS** → `git pull` → `npm run db:generate` → `pm2 restart agency-finance`.

Все изменения схемы и данных будут синхронизированы между локальной разработкой и VPS.

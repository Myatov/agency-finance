# Синхронизация базы данных

Есть два типа синхронизации: **схема** (структура таблиц) и **данные** (содержимое).

---

## 1. Синхронизация схемы (структуры)

Чтобы все окружения (локально, VPS) имели одинаковую структуру таблиц.

### Вариант A: `db push` (простой, без истории миграций)

Подходит для MVP и когда миграции ещё не ведёте.

**После изменения `prisma/schema.prisma`:**

```bash
npm run db:generate
npx prisma db push
```

- На **локальной** машине: в `.env` должен быть свой `DATABASE_URL` (локальная или удалённая БД).
- На **VPS**: после `git pull` выполнить те же команды на сервере в папке проекта.

Так схема в БД совпадёт с тем, что в репозитории.

### Вариант B: Миграции (история изменений в Git)

Удобно, когда несколько человек меняют схему и нужно единообразно обновлять все окружения.

**Один раз включить миграции (на одном из окружений):**

```bash
npx prisma migrate dev --name init
```

В репозитории появится папка `prisma/migrations/` — её нужно коммитить в Git.

**Дальше при каждом изменении схемы (у того, кто меняет):**

```bash
# Редактируешь prisma/schema.prisma, затем:
npx prisma migrate dev --name описание_изменения
git add prisma/migrations prisma/schema.prisma
git commit -m "DB: описание"
git push
```

**На других машинах и на VPS после `git pull`:**

```bash
npm run db:generate
npx prisma migrate deploy
```

Так схема везде будет совпадать, а история изменений хранится в `prisma/migrations/`.

---

## 2. Синхронизация данных (копирование содержимого БД)

Данные в Git не хранятся. Чтобы «синхронизировать» данные — делают дамп и восстановление.

### Экспорт данных (бэкап или копия «источника»)

С сервера или локально (подставь свои хост/пользователь/БД):

```bash
# Полный дамп (схема + данные)
pg_dump -h localhost -U agency_finance -d agency_finance -F c -f backup_$(date +%Y%m%d_%H%M%S).dump

# Или в виде SQL
pg_dump -h localhost -U agency_finance -d agency_finance -f backup.sql
```

Если БД на другом хосте: `-h IP_или_домен`. Пароль запросит или задаётся через `PGPASSWORD=...`.

### Восстановление данных («привести другую БД в то же состояние»)

```bash
# Из custom-формата (.dump)
pg_restore -h localhost -U agency_finance -d agency_finance --clean --if-exists backup_20260130.dump

# Из SQL
psql -h localhost -U agency_finance -d agency_finance -f backup.sql
```

Так ты «синхронизируешь» данные: одна БД становится копией другой.

### Типичные сценарии

| Задача | Действия |
|--------|----------|
| Бэкап продакшена | На VPS: `pg_dump ... -F c -f backup.dump`, скачать файл к себе. |
| Восстановить прод из бэкапа | На VPS: `pg_restore ... backup.dump` (предварительно проверить, что БД не занята). |
| Скопировать прод в локальную БД | Скачать дамп с сервера → локально `pg_restore ... -d agency_finance backup.dump`. |
| Очистить и залить только начальные данные | Локально/VPS: `npx prisma db push --force-reset` (осторожно, удалит все данные), затем `npm run db:seed`. |

---

## 3. Краткий чеклист «всё синхронизировано»

**Схема (структура):**

1. Меняешь `prisma/schema.prisma`.
2. Локально: `npm run db:generate` и `npx prisma db push` (или `npx prisma migrate dev` при использовании миграций).
3. Коммитишь `schema.prisma` (и при миграциях — папку `prisma/migrations/`).
4. На VPS после `git pull`: `npm run db:generate` и `npx prisma db push` (или `npx prisma migrate deploy`).

**Данные:**

- Не синхронизируются через Git.
- Нужна копия — делаешь дамп и восстанавливаешь в нужную БД (`pg_dump` / `pg_restore` или SQL).
- На новом окружении можно только применить сид: `npm run db:seed` (начальные роли/пользователи и т.д.).

Если напишешь, что именно хочешь синхронизировать (схему между компом и VPS, прод → тест, бэкапы и т.д.), можно расписать под твой случай по шагам.

# Полное описание сервиса «Финансы агентства» для передачи управляющей бизнеса

Документ описывает все разделы, функционал, особенности, взаимосвязи сущностей и правила доступа. Предназначен для передачи сервиса управляющей бизнеса или новому владельцу процессов.

**Содержание:** 1. Назначение сервиса · 2. Роли и права доступа · 3. Структура меню и разделы · 4. Сущности и взаимосвязи · 5. Счета на оплату и PDF · 6. Telegram · 7. Технические детали · 8. Связи между разделами · 9. Документы в проекте

---

## 1. Назначение сервиса

**«Финансы агентства»** — веб-приложение для учёта финансов агентства (онлайн-продвижение, разработка сайтов): клиенты, проекты (сайты), услуги, доходы и расходы, счета на оплату, оплаты, договора и закрывающие документы. Включает разграничение прав по ролям, отчёты и интеграцию с Telegram для уведомлений о расходах.

**Технологии:** Next.js 14, TypeScript, PostgreSQL (Prisma), авторизация по паролю (сессии в httpOnly cookie).

---

## 2. Роли и права доступа

### 2.1 Системные роли (не редактируются)

| Роль (код) | Название   | Доступ |
|------------|------------|--------|
| **OWNER**  | Владелец   | Полный доступ ко всем разделам, включая **Роли** и **Юрлица**. |
| **CEO**    | Генеральный директор | Полный доступ ко всем разделам **кроме** «Юрлица» и без изменения системных настроек ролей (роли видит и может настраивать). |

### 2.2 Настраиваемые роли

Права задаются по разделам и действиям в разделе **Настройки → Роли**. Разделы: сайты, услуги, клиенты, договора, закрывающие документы, хранилище, доходы, расходы, оплаты, сотрудники, продукты, отчёты, ниши, контакты, агенты, статьи расходов. Действия: просмотр (`view`), создание (`create`), редактирование (`edit`), удаление (`delete`), полное управление (`manage`), просмотр всех записей (`view_all`).

Типичные роли (могут быть переименованы и перенастроены):

- **HEAD_ACCOUNTING (Старший аккаунт)** — управление сайтами, доходами, расходами.
- **FINANCE (Финансист)** — просмотр и редактирование финансов.
- **ACCOUNT_MANAGER (Аккаунт-менеджер)** — видит и управляет только **своими** сайтами (где он назначен ответственным или создателем); доходы только по своим сайтам/услугам.
- **SELLER (Продавец)** — видит клиентов, где он указан продавцом; доходы только по своим клиентам.
- **HEAD (Руководитель отдела)** — управление сотрудниками **своего отдела** (назначается руководитель в разделе «Команда» / отделы).
- **EMPLOYEE (Сотрудник)** — базовый просмотр по разрешениям.
- **CONTRACTOR (Подрядчик)** — ограниченные права по настройке.

### 2.3 Контекстные ограничения

- **Расходы:** пользователь без прав «видеть все» видит только свои расходы, расходы где он указан сотрудником, или по сайтам, где он аккаунт-менеджер/создатель.
- **Доходы:** аккаунт-менеджер добавляет доходы только по услугам своих сайтов; продавец — только по клиентам, где он продавец.
- **Редактирование расхода:** разрешено создателю расхода или пользователям с правом полного управления расходами; дату платежа по расходу могут менять только OWNER и CEO.
- **Удаление расхода:** только OWNER и CEO.
- **Счета и оплаты (периоды):** доступ к периодам/счетам/оплатам по услуге проверяется по аккаунт-менеджеру сайта и продавцу клиента; FINANCE, HEAD_ACCOUNTING, OWNER, CEO видят всё.

---

## 3. Структура меню и разделы

Меню строится по правам: OWNER/CEO видят все пункты; остальные — только разделы, по которым есть право хотя бы «просмотр».

### 3.1 Клиенты и документы (выпадающее меню)

- **Клиенты** — справочник контрагентов. Поля: название, юрлицо (из справочника или своё название), продавец (сотрудник), агент/партнёр, реквизиты (адрес, ИНН, КПП, ОГРН, р/с, банк, БИК, КС, платёжные реквизиты, контакты), флаги «возвращающийся»/«ключевой» и комментарии статуса. От клиента зависят сайты и договора.
- **Договора** — привязка к клиенту (и опционально к сайту). Типы: договор, допсоглашение, NDA, прочее. Загрузка файлов, номер/дата/дата окончания, статус (активный/закрыт), комментарии. Есть разделы (секции) договора с привязкой к сайту/услуге.
- **Закрывающие документы** — пакеты по клиенту (и опционально сайт/услуга) и периоду (месяц/этап/разово). Статус пакета: в подготовке / отправлен / подписан. В пакет загружаются документы: акт, счёт, СФ, УПД, акт сверки, отчёт и т.д. Документ может быть привязан к рабочему периоду и/или счёту.
- **Сайты** — проекты клиентов. У каждого сайта: название, ссылка, описание, ниша (текст), клиент, аккаунт-менеджер, создатель. Флаг «активен». Сайт — родитель для услуг и для части расходов/договоров/закрывающих документов.
- **Услуги** — привязка к сайту и продукту. Поля: тип биллинга (разовый/ежемесячно/квартал/год), тип предоплаты (полная/частичная/постоплата), цена, даты начала/окончания, ответственный, комментарий, автопродление. По услуге ведутся **рабочие периоды**, доходы, счета и оплаты.

### 3.2 Доходы

Учёт поступлений по услугам. Запись дохода: сумма, услуга, опционально рабочий период и юрлицо, дата, комментарий. Список с фильтрами (период, аккаунт, продавец, сайт, услуга, продукт, юрлицо, клиент). Доступ к созданию/редактированию по правам и по привязке к «своим» услугам/клиентам (см. п. 2.3).

### 3.3 Расходы

Учёт затрат. Поля расхода: сумма, **статья расхода** (из справочника статей), опционально сотрудник, сайт, услуга, юрлицо, дата платежа, комментарий. Статьи расходов сгруппированы по **категориям расходов** и привязаны к **типам расходов финансовой модели** (для отчётности). Список с фильтрами по периоду, категории, статье, отделу, сотруднику, сайту, услуге, клиенту.

**Особенности:**

- При добавлении или изменении расхода в Telegram отправляется уведомление в группу «Расходы» (настраивается в .env: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_EXPENSES_CHAT_ID`). Формат сообщения: кто внёс/скорректировал, дата, клиент, проект, услуга, сумма, статья, сотрудник, юрлицо, комментарий.
- Редактировать может создатель расхода или пользователи с правом управления расходами; дату платежа — только OWNER/CEO; удалять — только OWNER/CEO.

### 3.4 Оплаты

Свод по **рабочим периодам** услуг: по каждому периоду отображаются ожидаемая сумма, выставленные счета, оплаты, остаток, наличие отчёта по периоду, просрочка, риски. Фильтры: период дат, аккаунт-менеджер, клиент. Переход в карточку периода — к созданию/редактированию счетов, загрузке отчёта по периоду и внесению оплат по счетам. Это **основная точка ввода** для счетов и оплат (см. также п. 5).

### 3.5 Отчёты

Три типа отчётов (с фильтрами по периоду и контексту):

- **Доходы** — выборка доходов с возможностью выгрузки в CSV.
- **Расходы** — выборка расходов с выгрузкой в CSV.
- **Сотрудники** — отчёт по сотрудникам (в разрезе отделов и т.п., в зависимости от реализации).

Доступ к разделу «Отчёты» контролируется правом просмотра отчётов.

### 3.6 Настройки (выпадающее меню)

Видимость пунктов зависит от роли и прав.

- **Хранилище** — общая точка входа к подразделам «Договора» и «Закрывающие документы».
- **Команда** — сотрудники и отделы. Должности, контакты, даты, привязка к отделу и роли. Смена пароля (своему учёту — любой; чужому — только OWNER/CEO). Руководитель отдела задаётся в отделе.
- **Продукты** — справочник продуктов (название, порядок). Используется при создании услуг.
- **Статьи расходов** — иерархия: категория расходов → статьи; у статьи также тип расхода финансовой модели. Порядок сортировки настраивается.
- **Ниши** — справочник ниш (иерархия родитель–потомок). На сайте хранится текст ниши (название).
- **Контакты** — общий справочник контактов (ФИО, телефоны, Telegram, WhatsApp, должность, заметка). Связь с клиентами через «роль у клиента» (владелец, маркетинг, финансы, ИТ и т.д.) и флаг «основной контакт».
- **Агенты / Партнёры** — справочник агентов: название, компания, вид деятельности, контакты, условия комиссии, источник (партнёр/агент/реферер/сотрудник), статус (активен/на паузе/архив). Привязка к клиентам.
- **Роли** — только для OWNER и CEO. Настройка ролей и разрешений по разделам (view, create, edit, delete, manage, view_all).
- **Юрлица** — только для OWNER. Справочник юрлиц (ИП/ООО и др.): название, ИНН, КПП, ОГРН, адрес, банк, р/с, БИК, КС, НДС %, УСН %, гендиректор, основание деятельности, флаги «формировать закрывающие», «закрывающий на каждый счёт». Используются в счетах (получатель), в доходах и расходах.

---

## 4. Сущности и взаимосвязи (кратко)

- **Клиент** → продавец (сотрудник), агент (опционально), юрлицо (опционально). Связан: сайты, договора, пакеты закрывающих документов, контакты (через связку клиент–контакт).
- **Сайт** → клиент, аккаунт-менеджер, создатель. Связан: услуги, расходы (опционально), договора, закрывающие пакеты.
- **Услуга** → сайт, продукт, ответственный (опционально). Связан: рабочие периоды, доходы, расходы (опционально), закрывающие пакеты.
- **Рабочий период (WorkPeriod)** → услуга, даты начала/окончания, тип периода (стандартный/расширенный/бонус/компенсация). Связан: счета (Invoice), доходы (опционально), отчёт по периоду (файл), закрывающие документы.
- **Счёт (Invoice)** → рабочий период, юрлицо (получатель), сумма, номер, даты охвата. Связан: оплаты (Payment), закрывающие документы.
- **Оплата (Payment)** → счёт, сумма, дата, комментарий, создатель.
- **Доход (Income)** → услуга, опционально рабочий период и юрлицо, сумма, дата, создатель/редактор.
- **Расход (Expense)** → статья расхода (CostItem), создатель; опционально сотрудник, сайт, услуга, юрлицо; дата платежа, комментарий.
- **Статья расхода (CostItem)** → категория расходов (CostCategory), тип расхода финансовой модели (FinancialModelExpenseType).
- **Юрлицо (LegalEntity)** используется в клиенте (плательщик), в счетах (получатель), в доходах и расходах.

---

## 5. Счета на оплату и печать PDF

- Создание и редактирование счетов выполняется в **карточке рабочего периода** (переход: Оплаты → период или Услуги → услуга → Периоды → период).
- По счёту задаётся: сумма, юрлицо-получатель, номер счёта (можно не заполнять — сгенерируется), даты охвата, флаги по закрывающим документам.
- **Формирование и печать PDF счёта:** в карточке периода есть ссылка «Формирование счёта» (страница формирования). На странице можно подправить **только для печати** (в БД не сохраняется): номер счёта и наименование услуги. Кнопка **«Печать отчета»** формирует PDF по бланку из `public/templates/schet-na-oplatu-blank-dlya-ip.pdf`, подставляет реквизиты плательщика (из карточки клиента), реквизиты получателя (из выбранного юрлица), сайт, услугу, период, сумму; при ненулевом НДС у юрлица добавляются НДС и сумма с НДС. Имя файла при скачивании — номер счёта. Подробности логики счёта — в `docs/INVOICE_FORM_RULES.md`.

---

## 6. Telegram

- Настраивается в `.env`: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_EXPENSES_CHAT_ID` (ID группы).
- При **добавлении** или **изменении** расхода бот отправляет одно сообщение в указанную группу. Текст: кто внёс/скорректировал, дата, сумма, статья, клиент, проект, услуга, сотрудник, юрлицо, комментарий (если есть).
- Проверка отправки: в браузере (под учёткой) открыть `https://ваш-домен/api/telegram/test` — отобразится, задан ли токен и успешна ли отправка тестового сообщения в группу.

---

## 7. Важные технические детали для эксплуатации

- **База данных:** PostgreSQL; схема и миграции — Prisma (`prisma/schema.prisma`, папка `prisma/`). Команды: `npm run db:generate`, `npx prisma db push` или миграции.
- **Переменные окружения:** `DATABASE_URL`, `NEXTAUTH_SECRET` (или аналог для сессий), при необходимости `SECURE_COOKIES`, для Telegram — `TELEGRAM_BOT_TOKEN`, `TELEGRAM_EXPENSES_CHAT_ID`. На сервере `.env` может собираться при деплое из секрета GitHub (base64), см. `docs/GITHUB_ACTIONS_SETUP.md`.
- **Деплой:** по push в ветку `main` запускается GitHub Actions — на сервере выполняется обновление кода, установка зависимостей, генерация Prisma Client, при необходимости применение миграций, сборка Next.js и перезапуск PM2. Инструкции после деплоя и при ошибках — в `README.md`.
- **Файлы:** загруженные договора и закрывающие документы хранятся на диске (пути и настройки — в коде хранилища и в конфигурации приложения).

---

## 8. Связи между разделами (логика работы)

1. **Клиент** — база для сайтов и договоров; реквизиты клиента подставляются в PDF счёта как плательщик.
2. **Сайт** — база для услуг; от него зависят видимость и право ведения расходов/доходов для аккаунт-менеджеров.
3. **Услуга** — база для рабочих периодов; из периода формируются счета и оплаты; по услуге ведутся доходы.
4. **Карточка периода** — единая точка ввода счетов, отчёта по периоду и оплат по счетам.
5. **Оплаты (раздел)** — свод по периодам и переход в карточку периода.
6. **Юрлица** — получатель в счетах; НДС юрлица влияет на расчёт НДС в PDF счёта.
7. **Статьи и категории расходов** — обязательный выбор при создании расхода; от них зависят отчёты по расходам и уведомления в Telegram.
8. **Роли и разрешения** — определяют видимость пунктов меню и возможность создавать/редактировать/удалять записи в каждом разделе, а также контекстные ограничения (свои клиенты/сайты/услуги).

---

## 9. Документы в проекте (справочно)

- **README.md** — установка, запуск, типовые проблемы, Telegram, деплой.
- **ARCHITECTURE.md** — архитектура и логика прав.
- **docs/PAYMENTS_INVOICES_UI.md** — где вносить счета и оплаты, как смотреть.
- **docs/INVOICE_FORM_RULES.md** — правила формирования счёта (PDF).
- **docs/GITHUB_ACTIONS_SETUP.md** — настройка деплоя и секрета для .env.
- **docs/SERVER_COMMANDS.md** — команды для настройки сервера (БД, nginx, PM2 и т.д.).
- **docs/VPS_DEPLOYMENT.md**, **docs/AUTO_DEPLOY.md** — развёртывание и автоматический деплой.

При передаче сервиса управляющей целесообразно передать доступ к репозиторию, серверу и учётной записи OWNER в приложении, а также пароли/токены (в безопасном виде) и этот документ.

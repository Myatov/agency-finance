# Подключение локального проекта к БД на VPS

Два способа: **SSH-туннель** (без открытия порта 5432 в интернет) и **прямое подключение** (открыть 5432 на VPS).

---

## Вариант 1: SSH-туннель (рекомендуется)

Порт PostgreSQL на VPS в интернет не открывается. Трафик идёт через SSH.

### На VPS ничего менять не нужно.

### На своём компьютере

**1. Поднять туннель** (в отдельном терминале, оставь его открытым):

```bash
ssh -L 5433:localhost:5432 пользователь@IP_ТВОЕГО_VPS -N
```

- `пользователь` — твой SSH-логин на VPS (например `root` или `ubuntu`).
- `IP_ТВОЕГО_VPS` — IP или домен сервера.
- Локальный порт `5433` выбран, чтобы не конфликтовать с локальным PostgreSQL (если он слушает 5432). Если локально Postgres нет — можно использовать `5432:localhost:5432`.

**2. В папке проекта создать/отредактировать `.env`:**

```env
# Подключение через туннель: хост localhost, порт как в -L (здесь 5433)
DATABASE_URL="postgresql://agency_finance:пароль_от_БД_на_VPS@localhost:5433/agency_finance?schema=public"
```

Пароль и имя БД/пользователя — те же, что на VPS (как при настройке сервера).

**3. Запуск проекта локально:**

```bash
npm run dev
```

Пока туннель запущен, приложение будет ходить в БД на VPS через него.

**Остановка:** в терминале с `ssh -L ...` нажми `Ctrl+C`.

---

## Вариант 2: Прямое подключение к БД на VPS

Локальный проект подключается к VPS по IP/домену на порт 5432. Нужно настроить PostgreSQL и фаервол на VPS.

**Подробная пошаговая инструкция:** [LOCAL_DIRECT_DB_CONNECTION.md](LOCAL_DIRECT_DB_CONNECTION.md)

### Шаг 1: На VPS — разрешить приём подключений

**1.1. Слушать на всех интерфейсах**

Обычно конфиг здесь: `/etc/postgresql/15/main/postgresql.conf` (цифра версии может быть 14 или 16).

```bash
sudo nano /etc/postgresql/15/main/postgresql.conf
```

Найди строку:

```
#listen_addresses = 'localhost'
```

Сделай так:

```
listen_addresses = '*'
```

Сохрани файл.

**1.2. Разрешить подключения пользователя с внешних хостов**

Файл: `/etc/postgresql/15/main/pg_hba.conf`

```bash
sudo nano /etc/postgresql/15/main/pg_hba.conf
```

В конец файла добавь (подставь свой IP или подсеть):

```
# Подключение с твоего IP (замени на свой IP)
host    agency_finance    agency_finance    ТВОЙ_IP/32    scram-sha-256
```

Узнать свой IP: в браузере открыть [ifconfig.me](https://ifconfig.me) или выполнить `curl ifconfig.me` локально. Если IP динамический, придётся периодически обновлять или использовать диапазон (менее безопасно).

**1.3. Перезапуск PostgreSQL**

```bash
sudo systemctl restart postgresql
```

**1.4. Фаервол: открыть порт 5432**

Только для твоего IP (безопаснее):

```bash
sudo ufw allow from ТВОЙ_IP to any port 5432
sudo ufw reload
```

Если ufw не включён: `sudo ufw enable`, затем команды выше.

### Шаг 2: Локально в `.env`

```env
DATABASE_URL="postgresql://agency_finance:пароль_от_БД_на_VPS@IP_ТВОЕГО_VPS:5432/agency_finance?schema=public"
```

Подставь реальные `IP_ТВОЕГО_VPS` и пароль пользователя `agency_finance`.

### Шаг 3: Запуск

```bash
npm run dev
```

---

## Сводка

| Способ              | Плюсы                         | Минусы                    |
|---------------------|-------------------------------|----------------------------|
| **SSH-туннель**     | Порт 5432 не открыт в интернет | Нужно держать туннель открытым |
| **Прямое подключение** | Не нужен туннель              | Нужно открывать 5432 и править Postgres |

Рекомендация: для разработки использовать **SSH-туннель**; прямое подключение — только если тебе так удобнее и ты ограничиваешь доступ по IP.

После настройки `.env` выполняй как обычно:

- `npm run db:generate`
- `npx prisma db push` — при изменении схемы (осторожно на общей БД)
- `npm run dev`

Все операции с БД пойдут на сервер.
